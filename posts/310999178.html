<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>é¡¹ç›®5ï¼šNodeç”¨æˆ·ç®¡ç†æ¥å£ï¼šå­¦ä¹ è®°å½•ç¯‡ | Nightwishã®blogğŸ§Š</title><meta name="keywords" content="Nodeã€MySQL2"><meta name="author" content="é£å„¿"><meta name="copyright" content="é£å„¿"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="é¡¹ç›®æ—¶é—´ï¼š 2021å¹´2æœˆ é¡¹ç›®èƒŒæ™¯ï¼š æ˜¥èŠ‚åœ¨å®¶ï¼Œåªæ˜¯æƒ³ç®€å•äº†è§£ä¸‹æ¥å£ã€æ•°æ®åº“çš„æ¦‚å¿µ å­¦ä¹ è®°å½•ç¯‡ï¼šè®°å½•è¿‡ç¨‹çš„ï¼Œè®°å¿†ä¸¢å¤±ï¼Œå˜¤å˜¤å˜¤  é¡¹ç›®å®æˆ˜Â· 1. åˆ’åˆ†ç›®å½•ç»“æ„Â·   åˆ’åˆ†æ–¹å¼ï¼š   æŒ‰ç…§åŠŸèƒ½æ¨¡å—åˆ’åˆ†ï¼›   æŒ‰ç…§ä¸šåŠ¡æ¨¡å—åˆ’åˆ†ï¼›     é¡¹ç›®é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼šÂ· &quot;start&quot;: &quot;nodemon .&#x2F;src&#x2F;main.js&quot;   é¡¹ç›®çš„å…¥å£æ–‡ä»¶ï¼šmain.js"><meta property="og:type" content="article"><meta property="og:title" content="é¡¹ç›®5ï¼šNodeç”¨æˆ·ç®¡ç†æ¥å£ï¼šå­¦ä¹ è®°å½•ç¯‡"><meta property="og:url" content="https://mynightwish.online/posts/310999178.html"><meta property="og:site_name" content="Nightwishã®blogğŸ§Š"><meta property="og:description" content="é¡¹ç›®æ—¶é—´ï¼š 2021å¹´2æœˆ é¡¹ç›®èƒŒæ™¯ï¼š æ˜¥èŠ‚åœ¨å®¶ï¼Œåªæ˜¯æƒ³ç®€å•äº†è§£ä¸‹æ¥å£ã€æ•°æ®åº“çš„æ¦‚å¿µ å­¦ä¹ è®°å½•ç¯‡ï¼šè®°å½•è¿‡ç¨‹çš„ï¼Œè®°å¿†ä¸¢å¤±ï¼Œå˜¤å˜¤å˜¤  é¡¹ç›®å®æˆ˜Â· 1. åˆ’åˆ†ç›®å½•ç»“æ„Â·   åˆ’åˆ†æ–¹å¼ï¼š   æŒ‰ç…§åŠŸèƒ½æ¨¡å—åˆ’åˆ†ï¼›   æŒ‰ç…§ä¸šåŠ¡æ¨¡å—åˆ’åˆ†ï¼›     é¡¹ç›®é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼šÂ· &quot;start&quot;: &quot;nodemon .&#x2F;src&#x2F;main.js&quot;   é¡¹ç›®çš„å…¥å£æ–‡ä»¶ï¼šmain.js"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://images.unsplash.com/photo-1638645671264-82cae622dada?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHx0b3BpYy1mZWVkfDUwfHhIeFlUTUhMZ09jfHxlbnwwfHx8fA%3D%3D&auto=format&fit=crop&w=500&q=60"><meta property="article:published_time" content="2021-12-11T16:42:57.000Z"><meta property="article:modified_time" content="2023-01-09T14:45:43.712Z"><meta property="article:author" content="é£å„¿"><meta property="article:tag" content="Nodeã€MySQL2"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://images.unsplash.com/photo-1638645671264-82cae622dada?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHx0b3BpYy1mZWVkfDUwfHhIeFlUTUhMZ09jfHxlbnwwfHx8fA%3D%3D&auto=format&fit=crop&w=500&q=60"><link rel="shortcut icon" href="/img/favicon.webp"><link rel="canonical" href="https://mynightwish.online/posts/310999178"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!1,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"å¤åˆ¶æˆåŠŸ",error:"å¤åˆ¶é”™è¯¯",noSupport:"æµè§ˆå™¨ä¸æ”¯æŒ"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"åˆšåˆš",min:"åˆ†é’Ÿå‰",hour:"å°æ—¶å‰",day:"å¤©å‰",month:"ä¸ªæœˆå‰"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isanchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"é¡¹ç›®5ï¼šNodeç”¨æˆ·ç®¡ç†æ¥å£ï¼šå­¦ä¹ è®°å½•ç¯‡",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-01-09 22:45:43"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));const n=()=>{GLOBAL_CONFIG_SITE.isHome&&/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")};n(),document.addEventListener("pjax:complete",n)})(window)</script><link rel="stylesheet" href="/css/custom.css" media="async" onload='this.media="all"'><link rel="stylesheet" href="/css/double.css" media="async" onload='this.media="all"'><link rel="stylesheet" href="/css/beautify.css" media="async" onload='this.media="all"'><link rel="stylesheet" href="/css/progress_bar.css" media="async" onload='this.media="all"'><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><style id="defineBg"></style><link rel="stylesheet" href="/css/universe.css" media="async" onload='this.media="all"'><link rel="stylesheet" href="//at.alicdn.com/t/c/font_3859043_rw1ayonelb.css" media="async" onload='this.media="all"'><link rel="stylesheet" href="/css/lastLoad.css" media="async" onload='this.media="all"'><svg aria-hidden="true" style="position:absolute;overflow:hidden;width:0;height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload='this.media="all"'><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"><style>#web_bg{background:var(--default-bg);background-attachment:local;background-position:center;background-size:cover;background-repeat:no-repeat}[data-theme=dark] #web_bg{background:var(--darkmode-bg)!important;background-attachment:local!important;background-position:center!important;background-size:cover!important;background-repeat:no-repeat!important}</style></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avartor.webp" onerror='onerror=null,src="https://mynightwish.oss-cn-beijing.aliyuncs.com/staticResource/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">112</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">91</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">14</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-food-strawberry"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-strawberry"></use></svg><span>é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-food-eggyolkcake"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-eggyolkcake"></use></svg><span>åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-food-popsicle"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-popsicle"></use></svg><span>æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-doughnut"></use></svg><span>è¶³è¿¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xiangjiB"></use></svg><span>æ–‡ç« </span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-diannaoB"></use></svg><span>åª’ä½“</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-erjiB"></use></svg><span>éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-dianshijiB"></use></svg><span>è§†é¢‘</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/books/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shouyinjiB"></use></svg><span>ä¹¦ç±</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-food-macaron"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-macaron"></use></svg><span>ç•™è¨€æ¿</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://images.unsplash.com/photo-1638645671264-82cae622dada?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHx0b3BpYy1mZWVkfDUwfHhIeFlUTUhMZ09jfHxlbnwwfHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=500&amp;q=60)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Nightwishã®blogğŸ§Š</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-food-strawberry"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-strawberry"></use></svg><span>é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw icon-food-eggyolkcake"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-eggyolkcake"></use></svg><span>åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw icon-food-popsicle"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-popsicle"></use></svg><span>æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-doughnut"></use></svg><span>è¶³è¿¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/charts/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xiangjiB"></use></svg><span>æ–‡ç« </span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-diannaoB"></use></svg><span>åª’ä½“</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-erjiB"></use></svg><span>éŸ³ä¹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-dianshijiB"></use></svg><span>è§†é¢‘</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/books/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-shouyinjiB"></use></svg><span>ä¹¦ç±</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-food-macaron"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-food-macaron"></use></svg><span>ç•™è¨€æ¿</span></a></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()"></a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:28px;width:28px;fill:currentColor;position:relative" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg><span>search.title</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:28px;width:28px;fill:currentColor;position:relative;margin-left:25px;margin-right:25px" aria-hidden="true"><use xlink:href="#icon-food-cookie"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:28px;width:28px;fill:currentColor;position:relative" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-xiuxi"></use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">é¡¹ç›®5ï¼šNodeç”¨æˆ·ç®¡ç†æ¥å£ï¼šå­¦ä¹ è®°å½•ç¯‡</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2021-12-11T16:42:57.000Z" title="å‘è¡¨äº 2021-12-12 00:42:57">2021-12-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-01-09T14:45:43.712Z" title="æ›´æ–°äº 2023-01-09 22:45:43">2023-01-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/2-4-%E9%A1%B9%E7%9B%AE/">2.4-é¡¹ç›®</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">9596</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>41åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="é¡¹ç›®5ï¼šNodeç”¨æˆ·ç®¡ç†æ¥å£ï¼šå­¦ä¹ è®°å½•ç¯‡"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><ul><li>é¡¹ç›®æ—¶é—´ï¼š 2021å¹´2æœˆ</li><li>é¡¹ç›®èƒŒæ™¯ï¼š æ˜¥èŠ‚åœ¨å®¶ï¼Œåªæ˜¯æƒ³ç®€å•äº†è§£ä¸‹æ¥å£ã€æ•°æ®åº“çš„æ¦‚å¿µ</li><li>å­¦ä¹ è®°å½•ç¯‡ï¼šè®°å½•è¿‡ç¨‹çš„ï¼Œè®°å¿†ä¸¢å¤±ï¼Œå˜¤å˜¤å˜¤</li></ul><h2 id="é¡¹ç›®å®æˆ˜">é¡¹ç›®å®æˆ˜<a class="anchor" href="#é¡¹ç›®å®æˆ˜">Â·</a></h2><h3 id="1-åˆ’åˆ†ç›®å½•ç»“æ„">1. åˆ’åˆ†ç›®å½•ç»“æ„<a class="anchor" href="#1-åˆ’åˆ†ç›®å½•ç»“æ„">Â·</a></h3><ul><li><p>åˆ’åˆ†æ–¹å¼ï¼š</p><ul><li><p>æŒ‰ç…§åŠŸèƒ½æ¨¡å—åˆ’åˆ†ï¼›</p></li><li><p>æŒ‰ç…§ä¸šåŠ¡æ¨¡å—åˆ’åˆ†ï¼›</p></li></ul></li><li><h4 id="é¡¹ç›®é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼š">é¡¹ç›®é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼š<a class="anchor" href="#é¡¹ç›®é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼š">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;start&quot;</span>: <span class="string">&quot;nodemon ./src/main.js&quot;</span></span><br></pre></td></tr></table></figure></li><li><h4 id="é¡¹ç›®çš„å…¥å£æ–‡ä»¶ï¼šmain-js">é¡¹ç›®çš„å…¥å£æ–‡ä»¶ï¼šmain.js<a class="anchor" href="#é¡¹ç›®çš„å…¥å£æ–‡ä»¶ï¼šmain-js">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">&#x27;./app/index&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./app/config&#x27;</span>)</span><br><span class="line"><span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">app.<span class="title function_">listen</span>(config.<span class="property">APP_PORT</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ&#x27;</span>,config.<span class="property">APP_PORT</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><h4 id="åˆ›å»ºæœåŠ¡å™¨ï¼šindex-js">åˆ›å»ºæœåŠ¡å™¨ï¼šindex.js<a class="anchor" href="#åˆ›å»ºæœåŠ¡å™¨ï¼šindex-js">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyParser&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†appä¼ å…¥åˆ°userRouterå‡½æ•°é‡Œé¢æ˜¯ä¸ºä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">	<span class="comment">// routeræ–‡ä»¶å¤¹ä¸‹çš„index.jsçš„ä½œç”¨ï¼šå¯¹routeræ–‡ä»¶å¤¹ä¸‹çš„æ¯ä¸ªrouter.jsæ–‡ä»¶éå†ï¼Œ</span></span><br><span class="line"><span class="comment">//å…å»æ¯æ³¨å†Œä¸€ä¸ªè·¯ç”±éƒ½è¦å†™ä¸€æ¬¡app.use(router1.allowed())å’Œapp.use(router1.routes())</span></span><br><span class="line"><span class="comment">//ä¼ å…¥appï¼Œæ˜¯å› ä¸ºä½¿ç”¨app.use()</span></span><br><span class="line"><span class="keyword">const</span> useRoutes = <span class="built_in">require</span>(<span class="string">&#x27;../router/index&#x27;</span>)</span><br><span class="line"><span class="title function_">useRoutes</span>(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> errorHandle = <span class="built_in">require</span>(<span class="string">&#x27;./error-handle&#x27;</span>)</span><br><span class="line"><span class="comment">//ç›‘å¬é”™è¯¯äº‹ä»¶</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errorHandle)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br></pre></td></tr></table></figure></li><li><h4 id="åŠ è½½é…ç½®çš„å˜é‡ï¼šconfig-js">åŠ è½½é…ç½®çš„å˜é‡ï¼šconfig.js<a class="anchor" href="#åŠ è½½é…ç½®çš„å˜é‡ï¼šconfig-js">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡dotenvå†…ç½®æ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> dotenv = <span class="built_in">require</span>(<span class="string">&#x27;dotenv&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line">dotenv.<span class="title function_">config</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»å–å…¬é’¥+ç§é’¥ </span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PRIVATE_KEY</span> = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname,<span class="string">&#x27;./keys/private.key&#x27;</span>))</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PUBLIC_KEY</span> = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname,<span class="string">&#x27;./keys/public.key&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¼å‡º</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="variable constant_">APP_PORT</span>,</span><br><span class="line">  <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">  <span class="variable constant_">MYSQL_PORT</span>,</span><br><span class="line">  <span class="variable constant_">MYSQL_USER</span>,</span><br><span class="line">  <span class="variable constant_">MYSQL_DATABASE</span>,</span><br><span class="line">  <span class="variable constant_">MYSQL_PASSWORD</span>,</span><br><span class="line">  <span class="variable constant_">LOCAL_HOST</span></span><br><span class="line">&#125; = process.<span class="property">env</span>;</span><br><span class="line"><span class="comment">//ä¸¤ç§exportsé¡ºåºä¸èƒ½æ¢</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">PUBLIC_KEY</span> = <span class="variable constant_">PUBLIC_KEY</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">PRIVATE_KEY</span> = <span class="variable constant_">PRIVATE_KEY</span>;</span><br></pre></td></tr></table></figure></li><li><h4 id="ç¼–å†™-envæ–‡ä»¶">ç¼–å†™.envæ–‡ä»¶<a class="anchor" href="#ç¼–å†™-envæ–‡ä»¶">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">APP_PORT</span> = <span class="number">8000</span></span><br><span class="line"><span class="variable constant_">LOCAL_HOST</span> = <span class="string">&quot;http://localhost</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MYSQL_HOST = &quot;</span>localhost<span class="string">&quot;</span></span><br><span class="line"><span class="string">MYSQL_PORT = 3306</span></span><br><span class="line"><span class="string">MYSQL_USER = &quot;</span>root<span class="string">&quot;</span></span><br><span class="line"><span class="string">MYSQL_DATABASE = &quot;</span>coderhub<span class="string">&quot;</span></span><br><span class="line"><span class="string">MYSQL_PASSWORD = &quot;</span>56830908zml<span class="string">&quot;</span></span><br></pre></td></tr></table></figure></li><li><h4 id="é”™è¯¯ç±»å‹æ¨¡å—ï¼šerror-type-js">é”™è¯¯ç±»å‹æ¨¡å—ï¼šerror-type.js<a class="anchor" href="#é”™è¯¯ç±»å‹æ¨¡å—ï¼šerror-type-js">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span> = <span class="string">&#x27;name_or_password_is_required&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_ALREADY_EXISITS</span> =  <span class="string">&#x27;user_alreay_exisits&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">USER_DOES_NOT_EXISITS</span> = <span class="string">&#x27;user_does_not_exisits&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PASSWORD_IS_NOT_CORRECT</span> = <span class="string">&#x27;password_is_not_correct&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NOT_AUTHORIZATION</span> = <span class="string">&#x27;not_authorization&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NOT_PERMISSION</span> = <span class="string">&#x27;not_permission&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="variable constant_">NAME_OR_PASSWORD_IS_REQUIRED</span>,</span><br><span class="line">  <span class="variable constant_">USER_ALREADY_EXISITS</span>,</span><br><span class="line">  <span class="variable constant_">USER_DOES_NOT_EXISITS</span>,</span><br><span class="line">  <span class="variable constant_">PASSWORD_IS_NOT_CORRECT</span>,</span><br><span class="line">  <span class="variable constant_">NOT_AUTHORIZATION</span>,</span><br><span class="line">  <span class="variable constant_">NOT_PERMISSION</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><h4 id="é”™è¯¯å¤„ç†æ¨¡å—-ï¼šerror-handle-js">é”™è¯¯å¤„ç†æ¨¡å— ï¼šerror-handle.js<a class="anchor" href="#é”™è¯¯å¤„ç†æ¨¡å—-ï¼šerror-handle-js">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&#x27;../constants/error-types&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">errorHandler</span> = (<span class="params">error, ctx</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">switch</span>(error.<span class="property">message</span>)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;name_or_password_is_required&#x27;</span>: </span><br><span class="line">      status = <span class="number">400</span>;</span><br><span class="line">      message = <span class="string">&#x27;ç”¨æˆ·å/å¯†ç ä¸èƒ½ä¸ºç©º&#x27;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;user_alreay_exisits&#x27;</span>:</span><br><span class="line">      status = <span class="number">409</span>,<span class="comment">// å‘ç”Ÿå†²çªconflict</span></span><br><span class="line">      message = <span class="string">&#x27;ç”¨æˆ·åå·²ç»ä½¿ç”¨&#x27;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;user_does_not_exisits&#x27;</span>:</span><br><span class="line">      status = <span class="number">400</span>,</span><br><span class="line">      message = <span class="string">&#x27;ç”¨æˆ·åä¸å­˜åœ¨&#x27;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;password_is_not_correct&#x27;</span>:</span><br><span class="line">      status = <span class="number">400</span>, </span><br><span class="line">      message = <span class="string">&#x27;å¯†ç ä¸æ­£ç¡®&#x27;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;not_authorization&#x27;</span>: </span><br><span class="line">      status = <span class="number">401</span>  </span><br><span class="line">      message = <span class="string">&#x27;æ²¡æœ‰æˆæƒï¼Œtokenæ— æ•ˆ&#x27;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;not_permission&#x27;</span>: </span><br><span class="line">      status = <span class="number">401</span>  </span><br><span class="line">      message = <span class="string">&#x27;ä½ æ²¡æœ‰æ“ä½œæƒé™&#x27;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="attr">default</span>: </span><br><span class="line">      status = <span class="number">404</span></span><br><span class="line">      message = <span class="string">&#x27;Not Found1&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  ctx.<span class="property">status</span> = status</span><br><span class="line">  ctx.<span class="property">body</span> = message</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = errorHandler</span><br></pre></td></tr></table></figure></li><li><h4 id="æ•°æ®åº“è¿æ¥ï¼šdatabase-js">æ•°æ®åº“è¿æ¥ï¼šdatabase.js<a class="anchor" href="#æ•°æ®åº“è¿æ¥ï¼šdatabase-js">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql2&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> connections = mysql.<span class="title function_">createPool</span>(&#123;</span><br><span class="line">  <span class="attr">host</span>: config.<span class="property">MYSQL_HOST</span>,</span><br><span class="line">  <span class="attr">port</span>: config.<span class="property">MYSQL_PORT</span>,</span><br><span class="line">  <span class="attr">user</span>: config.<span class="property">MYSQL_USER</span>,</span><br><span class="line">  <span class="attr">database</span>:config.<span class="property">MYSQL_DATABASE</span>,</span><br><span class="line">  <span class="attr">password</span>: config.<span class="property">MYSQL_PASSWORD</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">connections.<span class="title function_">getConnection</span>(<span class="function">(<span class="params">err, conn</span>) =&gt;</span> &#123;</span><br><span class="line">  conn.<span class="title function_">connect</span>( <span class="function"><span class="params">errr</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è¿æ¥å¤±è´¥&#x27;</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è¿æ¥æˆåŠŸ&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = connections.<span class="title function_">promise</span>()</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-ç”¨æˆ·æ³¨å†Œæ¥å£">2. ç”¨æˆ·æ³¨å†Œæ¥å£<a class="anchor" href="#2-ç”¨æˆ·æ³¨å†Œæ¥å£">Â·</a></h3><ul><li><p>ç”¨æˆ·æ³¨å†Œæ¥å£ç¼–å†™æµç¨‹ï¼š</p><ul><li><p>æ³¨å†Œç”¨æˆ·è·¯ç”±</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;verifyUser&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleWare/user.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title function_">router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/users&#x27;</span>&#125;)</span><br><span class="line">userRouter.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, verifyUser,create)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = userRouter;</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ³¨å†Œç”¨æˆ·æ ¡éªŒï¼šverifyUser">æ³¨å†Œç”¨æˆ·æ ¡éªŒï¼šverifyUser<a class="anchor" href="#æ³¨å†Œç”¨æˆ·æ ¡éªŒï¼šverifyUser">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&#x27;../constants/error-types&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">//1. è·å–ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line">  <span class="keyword">const</span> &#123;name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æœ‰ä¼ ï¼Œnameåº”è¯¥æ˜¯undefined</span></span><br><span class="line">  <span class="comment">//2. åˆ¤æ–­ç”¨æˆ·å/å¯†ç æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">  <span class="keyword">if</span> (!name || !password || name ===<span class="string">&#x27;&#x27;</span>|| password == <span class="string">&#x27;&#x27;</span> )&#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>)</span><br><span class="line">    <span class="comment">//æ­¤æ—¶å‘é€ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªåœ°æ–¹å»è·å–è¿™ä¸ªé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">//emitä¼ äº‹ä»¶ç±»å‹ï¼Œäº‹ä»¶ï¼Œå‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>,error, ctx)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//3. åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦å·²ç»å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">getUserByName</span>(name)</span><br><span class="line">  <span class="keyword">if</span>(result.<span class="property">length</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">USER_ALREADY_EXISITS</span>)</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, error, ctx) </span><br><span class="line">  	&#125;</span><br><span class="line">  <span class="comment">//å¿…é¡»è°ƒç”¨nextï¼Œç­‰åé¢çš„ä¸­é—´ä»¶æ‰§è¡Œæ‰è¿”å›ç»“æœ</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥è¯¢ç”¨æˆ·åæ˜¯å¦è¢«æ³¨å†Œè¿‡ï¼šuser.service.js</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> connection = <span class="built_in">require</span>(<span class="string">&#x27;../app/database&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">userService</span>&#123;</span><br><span class="line">  <span class="comment">// æŸ¥è¯¢æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·</span></span><br><span class="line">	<span class="keyword">async</span> <span class="title function_">getUserByName</span>(<span class="params">name</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM users WHERE name = ?`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [name])</span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>];</span><br><span class="line">  	&#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">user</span>)&#123;</span><br><span class="line">    <span class="comment">//è§£æ„user</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name, password&#125; = user;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO users (name, password) VALUES (?, ?)`</span>;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œsqlè¯­å¥</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [name, password]);</span><br><span class="line">    <span class="comment">//å°†userå­˜å‚¨åˆ°æ•°æ®åº“ä¸­</span></span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">userService</span>();</span><br></pre></td></tr></table></figure><h4 id="æ³¨å†Œç”¨æˆ·æ“ä½œï¼šcreate-js">æ³¨å†Œç”¨æˆ·æ“ä½œï¼šcreate.js<a class="anchor" href="#æ³¨å†Œç”¨æˆ·æ“ä½œï¼šcreate-js">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># éªŒè¯æ³¨å†Œç”¨æˆ·åçš„å¤„ç†é€»è¾‘æŠ½åˆ°user.<span class="property">controller</span>.<span class="property">js</span>é‡Œé¢</span><br><span class="line"><span class="keyword">const</span> service= <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">userController</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="comment">//è¿™éƒ¨åˆ†è¦åšçš„äº‹å¾ˆå¤šï¼Œæ‰€ä»¥å¯¹æ¯ä¸€éƒ¨åˆ†å†æŠ½å–ï¼š</span></span><br><span class="line">    <span class="comment">//è·å–ç”¨æˆ·ç”¨äºä¼ é€’çš„å‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> user = ctx.<span class="property">request</span>.<span class="property">body</span>   </span><br><span class="line">    <span class="comment">//æŸ¥è¯¢æ•°æ® ----æŠ½å–åˆ°user.service.js</span></span><br><span class="line">    <span class="comment">//useræ˜¯ä¼ å…¥çš„å‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">create</span>(user)  <span class="comment">// è§ä¸Šé¢çš„user.service.js</span></span><br><span class="line">    <span class="comment">//è¿”å›æ•°æ®</span></span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">userController</span>();</span><br></pre></td></tr></table></figure><h4 id="å¯†ç åŠ å¯†å­˜å‚¨">å¯†ç åŠ å¯†å­˜å‚¨<a class="anchor" href="#å¯†ç åŠ å¯†å­˜å‚¨">Â·</a></h4><p>æ­¤æ—¶å·²ç»æ‰‹åŠ¨æ³¨å†Œä¸¤ä¸ªç”¨æˆ·ï¼Œå¯åœ¨æ•°æ®åº“æŸ¥çœ‹ï¼š <img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210206144301822.png" alt="image-20210206144301822"></p></li></ul><p>ä½†æ˜¯è´¦æˆ·å¯†ç æ˜¯æ˜æ–‡çš„å½¢å¼ä¿å­˜çš„ï¼Œå¦‚æœæ•°æ®åº“æ³„éœ²äº†ï¼Œé‚£ä¹ˆå¯†ç ä¼šè¢«åˆ«äººæ‹¿åˆ°ç™»å½•ã€‚æ›´å±é™©çš„æ˜¯ï¼Œå¾ˆå¤šäººçš„å…¶ä»–è´¦æˆ·å¯†ç å…¨æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‹¿åˆ°ctx.request.bodyé‡Œé¢çš„ç”¨æˆ·å+å¯†ç ã€‚ç„¶ååŠ å¯†ã€‚ä½†æ˜¯å¼€å‘ä¸­å¹¶ä¸æ˜¯è¿™æ ·åšã€‚è€Œæ˜¯åœ¨verifyä¹‹ååšå¯†ç åŠ å¯†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">userRouter.post(&#x27;/&#x27;, verifyUser,**å¢åŠ æ‹¦æˆªä¸­é—´ä»¶handlePassword***ï¼Œcreate)</span><br></pre></td></tr></table></figure><p>åŠ å¯†ä¸­é—´ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&#x27;../constants/error-types&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> md5password = <span class="built_in">require</span>(<span class="string">&#x27;../utils/password-handle&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handlePassword</span> = <span class="keyword">async</span>(<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">  <span class="comment">//é€šè¿‡åŠ å¯†å‡½æ•°ï¼Œå¯¹password</span></span><br><span class="line">  ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">password</span> = <span class="title function_">md5password</span>(password) </span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  verifyUser,</span><br><span class="line">  handlePassword</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ å¯†çš„æ–¹å¼MD5ï¼Œå€ŸåŠ©<strong>æ¡†æ¶crypto</strong>ï¼Œnodeè‡ªå¸¦çš„ï¼Œæœ‰ä¸€ä¸ªå‡½æ•°è°ƒç”¨createHash()</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">md5password</span> = (<span class="params">password</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> md5 = crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line">  <span class="comment">// è¿”å›è¿˜æ˜¯ä¸€ä¸ªå¯¹è±¡,å¹¶è½¬æˆ16è¿›åˆ¶çš„ç»“æœ,æœ€ç»ˆæ‹¿åˆ°å­—ç¬¦ä¸²å½¢å¼</span></span><br><span class="line">  <span class="keyword">const</span> result = md5.<span class="title function_">update</span>(password).<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = md5password</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210206151111074.png" alt="image-20210206151111074"></p><p>æ•°æ®åº“é‚£è¾¹ä¹Ÿå·²ç»æ˜¾ç¤ºçš„æ˜¯åŠ å¯†åçš„å¯†ç </p><h3 id="3-ç™»å½•æ¥å£">3. ç™»å½•æ¥å£<a class="anchor" href="#3-ç™»å½•æ¥å£">Â·</a></h3><ul><li><p>ç™»å½•è·¯å¾„æ˜¯/login</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># æ–°å»ºè·¯ç”±é…ç½®auth.<span class="property">router</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">const</span> authRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line"><span class="keyword">const</span> &#123;login&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/auth.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line">authRouter.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, login)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># é…ç½®è·¯ç”±</span><br><span class="line">app.<span class="title function_">use</span>(authRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(authRouter.<span class="title function_">allowedMethods</span>())</span><br></pre></td></tr></table></figure><ul><li><h4 id="ç™»å½•å¤„ç†ï¼šlogin">ç™»å½•å¤„ç†ï¼šlogin<a class="anchor" href="#ç™»å½•å¤„ç†ï¼šlogin">Â·</a></h4></li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AuthController</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">//æ‹¿åˆ°ç”¨æˆ·å</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`æ¬¢è¿<span class="subst">$&#123;name&#125;</span>å›æ¥`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">AuthController</span>();</span><br></pre></td></tr></table></figure></li><li><p>æ­¤æ—¶ï¼Œç”¨æˆ·éšä¾¿è¾“å…¥å¯†ç è´¦æˆ·éƒ½å¯ä»¥ç™»å½•ï¼Œå¹¶æ²¡æœ‰éªŒè¯ï¼Œåœ¨/loginçš„postè¯·æ±‚ä¸­æ’å…¥ä¸­é—´ä»¶</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">authRouter.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>,***ä¸­é—´ä»¶verifyLogin***, login)</span><br></pre></td></tr></table></figure><h4 id="å¯†ç éªŒè¯ï¼š">å¯†ç éªŒè¯ï¼š<a class="anchor" href="#å¯†ç éªŒè¯ï¼š">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> errorType = <span class="built_in">require</span>(<span class="string">&#x27;../constants/error-types&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> md5password = <span class="built_in">require</span>(<span class="string">&#x27;../utils/password-handle&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyLogin</span> = <span class="keyword">async</span>(<span class="params">ctx, next</span>) =&gt;&#123;</span><br><span class="line"><span class="comment">//1.è·å–ç”¨æˆ·å+å¯†ç </span></span><br><span class="line">  <span class="keyword">const</span> &#123;name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//ç”¨æˆ·å/å¯†ç æ˜¯å¦ä¸ºç©º</span></span><br><span class="line"><span class="comment">//2. åˆ¤æ–­ç”¨æˆ·å/å¯†ç æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">  <span class="keyword">if</span> (!name || !password)&#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NAME_OR_PASSWORD_IS_REQUIRED</span>)</span><br><span class="line">    <span class="comment">//æ­¤æ—¶å‘é€ä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªåœ°æ–¹å»è·å–è¿™ä¸ªé”™è¯¯ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">//emitä¼ äº‹ä»¶ç±»å‹ï¼Œäº‹ä»¶ï¼Œå‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>,error, ctx)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//3.ç”¨æˆ·å/å¯†ç æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">getUserByName</span>(name)</span><br><span class="line">  <span class="keyword">const</span> user = result[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">if</span>(!user)&#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">USER_DOES_NOT_EXISITS</span>)</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, error, ctx)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//4.ç”¨æˆ·å/å¯†ç æ˜¯å¦ä¸€è‡´(åŠ å¯†)</span></span><br><span class="line">  <span class="comment">//user.passwordæ˜¯ä¹‹å‰æ•°æ®åº“ä¸­å­˜å‚¨çš„å¯†ç ï¼Œè€Œä¸”æ˜¯å·²ç»åŠ å¯†äº†çš„</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_">md5password</span>(password) !== user.<span class="property">password</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">PASSWORD_IS_NOT_CORRECT</span>)</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, error, ctx)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//5.å®Œæˆæ‰€æœ‰éªŒè¯æ­¥éª¤åï¼Œå†æ‰§è¡Œrouteråé¢çš„ä¸­é—´ä»¶</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = verifyLogin</span><br></pre></td></tr></table></figure></li><li><h4 id="ä¼˜åŒ–è·¯ç”±æ³¨å†Œï¼ŒåŠ¨æ€åŠ è½½è·¯ç”±ï¼š">ä¼˜åŒ–è·¯ç”±æ³¨å†Œï¼ŒåŠ¨æ€åŠ è½½è·¯ç”±ï¼š<a class="anchor" href="#ä¼˜åŒ–è·¯ç”±æ³¨å†Œï¼ŒåŠ¨æ€åŠ è½½è·¯ç”±ï¼š">Â·</a></h4></li></ul><p>ä¹‹å‰æ¯ç›‘ç†ä¸€ä¸ªè·¯ç”±éƒ½è¦è¿›è¡Œä¸€æ¬¡æ³¨å†Œï¼Œå½“è·¯ç”±è¶Šæ¥è¶Šå¤šï¼Œindex.jsé‡Œé¢çš„å†…å®¹è¶Šæ¥è¶Šå¤šã€‚å¯¹è¿™éƒ¨åˆ†ä»£ç ç®€åŒ–</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># index.<span class="property">js</span>åˆ é™¤</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">allowedMethods</span>())</span><br><span class="line">app.<span class="title function_">use</span>(authRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(authRouter.<span class="title function_">allowedMethods</span>())</span><br><span class="line"># æ”¹ä¸º</span><br><span class="line"><span class="keyword">const</span> useRoutes = <span class="built_in">require</span>(<span class="string">&#x27;../router/index&#x27;</span>)</span><br><span class="line"><span class="title function_">useRoutes</span>(app)</span><br></pre></td></tr></table></figure><p>åœ¨routeræ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å¢index.js</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useRoutes</span> = (<span class="params">app</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">//è¯»å–å½“å‰æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œè¿”å›çš„ç»“æœæ˜¯æ•°ç»„</span></span><br><span class="line">  fs.<span class="title function_">readdirSync</span>(__dirname).<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//å¯¹å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éå†ï¼Œé™¤äº†index.js</span></span><br><span class="line">    <span class="keyword">if</span>(file === <span class="string">&#x27;index.js&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å¯¹æ¯ä¸ªrouter.jsæ–‡ä»¶è¿›è¡Œå¯¼å…¥</span></span><br><span class="line">    <span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;$&#123;file&#125;&#x27;</span>)</span><br><span class="line">    app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">    app.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>())</span><br><span class="line">  &#125;) </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = useRoutes</span><br></pre></td></tr></table></figure><h3 id="4-ç™»å½•å‡­è¯ï¼š">4. ç™»å½•å‡­è¯ï¼š<a class="anchor" href="#4-ç™»å½•å‡­è¯ï¼š">Â·</a></h3><ul><li><p>éªŒè¯æ–¹å¼1ï¼šcookie+sessionï¼›ï¼ˆæ­£åœ¨è¢«æ·˜æ±°ï¼‰</p><p>éªŒè¯æ–¹å¼2ï¼šTokenä»¤ç‰Œï¼›ç™»å½•æˆåŠŸè¿”å›å‡­è¯ï¼šï¼ˆæœªæ¥æ›´æµè¡Œï¼‰</p></li><li><p>æœ‰å…³cookieã€sessionã€tokençš„çŸ¥è¯†åœ¨14ç« èŠ‚ç¬”è®°ï¼štokené‡‡ç”¨äº†ç”Ÿæˆtokenæ—¶å’ŒéªŒè¯tokenæ—¶ä½¿ç”¨åŒä¸€å¯†é’¥çš„æ–¹å¼</p></li></ul><h4 id="éå¯¹ç§°åŠ å¯†">éå¯¹ç§°åŠ å¯†<a class="anchor" href="#éå¯¹ç§°åŠ å¯†">Â·</a></h4><ul><li><p>å¦‚æœsecretKeyæš´éœ²æ˜¯ä¸€ä»¶éå¸¸å±é™©çš„äº‹æƒ…ï¼Œå› ä¸ºä¹‹åå°±å¯ä»¥æ¨¡æ‹Ÿé¢å‘tokenï¼Œ ä¹Ÿå¯ä»¥è§£å¯†tokenï¼›æ‰€ä»¥HS256åŠ å¯†ç®—æ³•ä¸€å•å¯†é’¥æš´éœ²å°±æ˜¯éå¸¸å±é™©çš„äº‹æƒ…ã€‚</p><ul><li><p>æ¯”å¦‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸€ä¸ªå­ç³»ç»Ÿéƒ½éœ€è¦è·å–åˆ°å¯†é’¥ï¼›é‚£ä¹ˆæ‹¿åˆ°è¿™ä¸ªå¯†é’¥åè¿™ä¸ªå­ç³»ç»Ÿæ—¢å¯ä»¥å‘å¸ƒå¦å¤–ï¼Œä¹Ÿå¯ä»¥éªŒè¯ä»¤ç‰Œï¼›</p></li><li><p>ä½†æ˜¯å¯¹äºä¸€äº›èµ„æºæœåŠ¡å™¨æ¥è¯´ï¼Œå®ƒä»¬åªéœ€è¦æœ‰éªŒè¯ä»¤ç‰Œçš„èƒ½åŠ›å°±å¯ä»¥äº†ï¼›è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼ŒRS256ï¼š <img src="C:\Users\å°è™ç‰™\AppData\Roaming\Typora\typora-user-images\image-20210206220511367.png" alt="image-20210206220511367" style="zoom:67%"></p><ul><li>ç§é’¥ï¼ˆprivate keyï¼‰ï¼šç”¨äºå‘å¸ƒä»¤ç‰Œ</li><li>å…¬é’¥ï¼ˆpublic keyï¼‰ï¼šç”¨äºéªŒè¯ä»¤ç‰Œï¼Œæ˜¯é€šè¿‡ç§é’¥å¾—åˆ°çš„</li></ul></li><li><p>å¯ä»¥ä½¿ç”¨opensslæ¥ç”Ÿæˆä¸€å¯¹ç§é’¥å’Œå…¬é’¥ï¼šMacç›´æ¥ä½¿ç”¨terminalç»ˆç«¯å³å¯ï¼›Windowsé»˜è®¤çš„cmdç»ˆç«¯æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨çš„ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨git bashç»ˆç«¯ï¼›</p></li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹¿åˆ°å…¬é’¥+ç§é’¥,æ‹¿åˆ°çš„æ˜¯bufferï¼Œä½†æ˜¯åé¢æ˜¯å¯ä»¥ä¼ å…¥bufferçš„</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PRIVATE_KEY</span> = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./keys/private.key&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PUBLIC_KEY</span> = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./keys/public.key&#x27;</span>)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/test&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//åŸºäºtokenå®ç°ï¼šjwtï¼Œæ‰‹é‡Œç”¨ç§é’¥åŠ å¯†</span></span><br><span class="line">  <span class="keyword">const</span> user = &#123;<span class="attr">id</span>: <span class="number">110</span>, <span class="attr">name</span>:<span class="string">&#x27;lily&#x27;</span>&#125;</span><br><span class="line">  <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(user, <span class="variable constant_">PRIVATE_KEY</span>, &#123;</span><br><span class="line">    <span class="attr">expiresIn</span>: <span class="number">10</span>*<span class="number">100</span>,</span><br><span class="line">    <span class="comment">//åŠ å¯†ç®—æ³•</span></span><br><span class="line">    <span class="attr">algorithm</span>: <span class="string">&quot;RS256&quot;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  ctx.<span class="property">body</span> = token</span><br><span class="line">&#125;)</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/demo&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//å–å‡ºtoken</span></span><br><span class="line">  <span class="keyword">const</span> authorization = ctx.<span class="property">headers</span>.<span class="property">authorization</span></span><br><span class="line">  <span class="keyword">const</span> token = authorization.<span class="title function_">replace</span>(<span class="string">&quot;Bearer &quot;</span>,<span class="string">&quot;&quot;</span> )</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line"> 		 <span class="comment">//éªŒè¯tokenï¼Œæ‰‹é‡Œæœ‰å…¬é’¥è§£å¯†</span></span><br><span class="line">  	<span class="keyword">const</span> result = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">PUBLIC_KEY</span>, &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œä¼ å…¥çš„æ˜¯æ•°ç»„ï¼Œè€Œä¸”å¤æ•°ï¼Œè¯´æ˜å¯ä»¥ä¼ å¾ˆå¤š</span></span><br><span class="line">    <span class="attr">algorithms</span>: [<span class="string">&quot;RS256&quot;</span>]</span><br><span class="line">  	&#125;)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125; <span class="keyword">catch</span>(error) &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;tokenæ˜¯æ— æ•ˆçš„&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8080</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;koaå¯åŠ¨æˆåŠŸäº†&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>è¡¥å……ï¼šfs.readFileSyncæœ‰æ—¶å€™å¯ä»¥ä¼ ç›¸å¯¹è·¯å¾„ï¼Œç»å¯¹è·¯å¾„ã€‚ä½†æ˜¯æœ‰æ—¶åˆä¸å¯ä»¥ã€‚åœ¨é¡¹ç›®ä¸­çš„ä»»ä½•åœ°æ–¹ï¼Œç›¸å¯¹è·¯å¾„æ˜¯ç›¸å¯¹äºprocessçš„cwdï¼Œåœ¨å“ªä¸ªæ–‡ä»¶å¤¹å¯åŠ¨çš„é¡¹ç›®å°±æ˜¯process.cwd</li></ul></li><li><h4 id="é¢å‘ä»¤ç‰Œ-éªŒè¯ä»¤ç‰Œï¼ˆå›åˆ°é¡¹ç›®ï¼‰">é¢å‘ä»¤ç‰Œ+éªŒè¯ä»¤ç‰Œï¼ˆå›åˆ°é¡¹ç›®ï¼‰<a class="anchor" href="#é¢å‘ä»¤ç‰Œ-éªŒè¯ä»¤ç‰Œï¼ˆå›åˆ°é¡¹ç›®ï¼‰">Â·</a></h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¯»å–å…¬é’¥+ç§é’¥ </span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PRIVATE_KEY</span> = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname,<span class="string">&#x27;./keys/private.key&#x27;</span>))</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PUBLIC_KEY</span> = fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(__dirname,<span class="string">&#x27;./keys/public.key&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸¤ç§exportsé¡ºåºä¸èƒ½æ¢</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">PUBLIC_KEY</span> = <span class="variable constant_">PUBLIC_KEY</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">PRIVATE_KEY</span> = <span class="variable constant_">PRIVATE_KEY</span>;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># auth.<span class="property">controller</span>.<span class="property">js</span> </span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">PUBLIC_KEY</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../app/config&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">PRIVATE_KEY</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../app/config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthController</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">//æ‹¿åˆ°ç”¨æˆ·å</span></span><br><span class="line">    <span class="keyword">const</span> &#123;id, name&#125; = ctx.<span class="property">user</span> </span><br><span class="line">    <span class="comment">//é¢å‘ä»¤ç‰Œ</span></span><br><span class="line">    <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;id, name&#125;, <span class="variable constant_">PRIVATE_KEY</span>, &#123;</span><br><span class="line">      <span class="attr">expiresIn</span>: <span class="number">10</span>*<span class="number">100</span>*<span class="number">60</span>,</span><br><span class="line">      <span class="attr">algorithm</span>: <span class="string">&#x27;RS256&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      id, token, name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">AuthController</span>();</span><br></pre></td></tr></table></figure></li><li><h4 id="éªŒè¯ç”¨æˆ·æ˜¯å¦æˆæƒï¼Œé¢å‘çš„ç­¾åæ˜¯å¦æœ‰æ•ˆ">éªŒè¯ç”¨æˆ·æ˜¯å¦æˆæƒï¼Œé¢å‘çš„ç­¾åæ˜¯å¦æœ‰æ•ˆ<a class="anchor" href="#éªŒè¯ç”¨æˆ·æ˜¯å¦æˆæƒï¼Œé¢å‘çš„ç­¾åæ˜¯å¦æœ‰æ•ˆ">Â·</a></h4><p>æ¯”å¦‚å½“ä¸€ä¸ªç”¨æˆ·ç™»å½•ä¹‹åï¼Œå‘è¡¨åŠ¨æ€ï¼Œå‘è¡¨æ–‡ç« ä¹‹å‰æˆ‘ä»¬è¦éªŒè¯è¯¥ç”¨æˆ·æ˜¯å¦æˆæƒ</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># éªŒè¯çš„è·¯å¾„æ˜¯/test,getè¯·æ±‚</span><br><span class="line">authRouter.<span class="title function_">get</span>(<span class="string">&#x27;/test&#x27;</span>, verifyAuth, success)<span class="comment">//successåªæ˜¯æ˜¾ç¤ºéªŒè¯æˆåŠŸçš„åŠŸèƒ½</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># auth.<span class="property">middleware</span>.<span class="property">js</span>  éªŒè¯å‡½æ•°</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyAuth</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;éªŒè¯æˆæƒçš„middleware&#x27;</span>)</span><br><span class="line">  <span class="comment">// æ³¨æ„è¿™é‡Œå‘é€è¯·æ±‚æ—¶åœ¨postmené‡Œè®°å¾—æŠŠtokenå¤åˆ¶ï¼Œæºå¸¦è¿‡å»</span></span><br><span class="line">  <span class="keyword">const</span> authorization = ctx.<span class="property">headers</span>.<span class="property">authorization</span></span><br><span class="line">  <span class="comment">//å¦‚æœæˆ‘ä»¬åœ¨postmanä¸­æºå¸¦é”™è¯¯çš„tokenä¼ è¿‡æ¥ï¼Œ</span></span><br><span class="line">  <span class="comment">//æ­¤æ—¶ctx.headersé‡Œé¢å‹æ ¹å°±æ²¡æœ‰authorization</span></span><br><span class="line">  <span class="comment">//æ‰€ä»¥è¦å…ˆéªŒè¯ä¸€é</span></span><br><span class="line">  <span class="keyword">if</span>(!authorization)&#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NOT_AUTHORIZATION</span>)</span><br><span class="line">    <span class="comment">//è¿™é‡Œå¿…é¡»æ˜¯return,å¦åˆ™ä¼šå¡åœ¨è¿™é‡Œ</span></span><br><span class="line">     <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, error, ctx)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> token = authorization.<span class="title function_">replace</span>(<span class="string">&#x27;Bearer &#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">// éªŒè¯token</span></span><br><span class="line">    <span class="keyword">const</span> result = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">PUBLIC_KEY</span>, &#123;</span><br><span class="line">    <span class="attr">algorithms</span>: [<span class="string">&#x27;RS256&#x27;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">  &#125; <span class="keyword">catch</span>(err)&#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NOT_AUTHORIZATION</span>)</span><br><span class="line">    ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, error, ctx)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-1-å‘å¸ƒ-æŸ¥è¯¢åŠ¨æ€å†…å®¹">5.1 å‘å¸ƒ/æŸ¥è¯¢åŠ¨æ€å†…å®¹<a class="anchor" href="#5-1-å‘å¸ƒ-æŸ¥è¯¢åŠ¨æ€å†…å®¹">Â·</a></h3><h4 id="1-å‘å¸ƒåŠ¨æ€å†…å®¹">1. å‘å¸ƒåŠ¨æ€å†…å®¹<a class="anchor" href="#1-å‘å¸ƒåŠ¨æ€å†…å®¹">Â·</a></h4><ul><li><p>æ–°å»ºmoment.router.js</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;verifyAuth&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleWare/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/moment.controller.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> momentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/moment&#x27;</span>&#125;)</span><br><span class="line"><span class="comment">//å‘è¡¨è¯„è®ºä¹‹å‰è¦å…ˆéªŒè¯ç™»å½•ï¼Œç„¶åæ‰æ˜¯createåˆ›å»ºè¯„è®º</span></span><br><span class="line">momentRouter.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, verifyAuth, create)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = momentRouter </span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæ–°çš„è¡¨ moment</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">TABLE</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">`moment`</span> (</span><br><span class="line">  <span class="comment">// è¯„è®ºçš„idï¼Œè¡¨ç¤ºå“ªæ¡è¯„è®º</span></span><br><span class="line">  id <span class="variable constant_">INT</span> <span class="variable constant_">PRIMARY</span> <span class="variable constant_">KEY</span> <span class="variable constant_">AUTO_INCREMENT</span>,</span><br><span class="line">  content <span class="title function_">VARCHAR</span>(<span class="number">1000</span>) <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span>,</span><br><span class="line">  <span class="comment">// è¯¥è¯„è®ºå¯¹åº”çš„ç”¨æˆ·id</span></span><br><span class="line">  user_id <span class="variable constant_">INT</span> <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span>,</span><br><span class="line">  createAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  updateAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="comment">// å¼•ç”¨å¤–é”®çº¦æŸï¼Œuser_idæ˜¯å‘è¡¨è¯„è®ºå¯¹åº”çš„ç”¨æˆ·çš„idï¼Œ</span></span><br><span class="line">  <span class="comment">// users(id)æ˜¯ç”¨æˆ·è¡¨ä¸­çš„ç”¨æˆ·çš„idï¼Œè¡¨ç¤ºå“ªä¸ªç”¨æˆ·ï¼ŒäºŒè€…åº”è¯¥æ˜¯è”åŠ¨çš„</span></span><br><span class="line">  <span class="comment">// ä»£è¡¨äº†å“ªæ¡è¯„è®ºå¯¹åº”äº†å“ªä¸ªç”¨æˆ·</span></span><br><span class="line">  <span class="variable constant_">FOREIGN</span> <span class="title function_">KEY</span>(user_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">users</span>(id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰å‘å¸ƒåŠ¨æ€å†…å®¹çš„æ¥å£</p><ul><li><p>éªŒè¯ç”¨æˆ·ç™»å½•: verifyAuthç›´æ¥å¯¼å…¥ä½¿ç”¨</p></li><li><p>Controllerå’ŒServiceä¸­å¤„ç†å†…å®¹</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">const</span> momentService = <span class="built_in">require</span>(<span class="string">&#x27;../service/moment.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">momentController</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">  <span class="comment">// å‘è¡¨åŠ¨æ€çš„é€»è¾‘:</span></span><br><span class="line">    <span class="comment">//1.æ‹¿åˆ°user_id, åŠ¨æ€å†…å®¹ï¼Œä¸Šä¸€ä¸ªä¸­é—´ä»¶çš„ctx.useré‡Œé¢å­˜ç€</span></span><br><span class="line">    <span class="keyword">const</span> user_id = ctx.<span class="property">user</span>.<span class="property">id</span>   <span class="comment">// æ‹¿åˆ°ç”¨æˆ·idï¼Œæ˜¯å“ªä¸ªç”¨æˆ·</span></span><br><span class="line">    <span class="keyword">const</span> content = ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">content</span>  <span class="comment">// æ˜¯ä»€ä¹ˆåŠ¨æ€å†…å®¹</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. å°†æ•°æ®æ’å…¥åˆ°æ•°æ®åº“ä¸­</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">create</span>(user_id, content)</span><br><span class="line">    ctx.<span class="property">body</span> =  result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">momentController</span>();</span><br></pre></td></tr></table></figure></li><li><p>moment.service.js</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">const connection = require(&#x27;../app/database&#x27;)</span><br><span class="line">class momentService&#123;</span><br><span class="line">  async create(user_id, content)&#123;</span><br><span class="line">    const statement = `INSERT INTO moment (content, user_id) VALUES (?, ?)`</span><br><span class="line">    const result = connection.execute(statement, [content, user_id])</span><br><span class="line">    return result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">module.exports = new momentService();</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210207173925587.png" alt="image-20210207173925587"></p></li></ul></li></ul><h4 id="2-æŸ¥è¯¢åŠ¨æ€å†…å®¹">2.æŸ¥è¯¢åŠ¨æ€å†…å®¹<a class="anchor" href="#2-æŸ¥è¯¢åŠ¨æ€å†…å®¹">Â·</a></h4><ul><li><p>å®šä¹‰æŸ¥è¯¢å•ä¸ªå†…å®¹çš„æ¥å£</p><ul><li><p>æ ¹æ®momentIdæŸ¥è¯¢æ¥å£å†…å®¹ï¼›</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># è·¯ç”±</span><br><span class="line"><span class="comment">// æŸ¥çœ‹è¯„è®º,ä¸éœ€è¦ç™»å½•,éœ€è¦çŸ¥é“è¯„è®ºå¯¹åº”çš„id</span></span><br><span class="line">momentRouter.<span class="title function_">get</span>(<span class="string">&#x27;/:momentId&#x27;</span>, momentDetail)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">momentDetail</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// ä»æ•°æ®åº“ä¸­è·å–è¯„è®ºä¿¡æ¯ï¼Œéœ€è¦id,</span></span><br><span class="line">    <span class="comment">//1. idæ˜¯è¯·æ±‚æ¥å£paramsé‡Œé¢æºå¸¦çš„momentId</span></span><br><span class="line">    <span class="keyword">const</span> momentId = ctx.<span class="property">params</span>.<span class="property">momentId</span></span><br><span class="line">    <span class="comment">//2.æ‹¿åˆ°idå»æ•°æ®åº“æŸ¥è¯¢è¯„è®ºä¿¡æ¯,è®©serviceåš</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">getMomentById</span>(momentId)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># å»æ•°æ®åº“æŸ¥è¯¢å†…å®¹</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getMomentById</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT </span></span><br><span class="line"><span class="string">      m.id id, m.content content, </span></span><br><span class="line"><span class="string">      m.createAt createTime, m.updateAt updateTime, </span></span><br><span class="line"><span class="string">      JSON_OBJECT(&#x27;id&#x27;, u.id, &#x27;name&#x27;, u.name) author</span></span><br><span class="line"><span class="string">      FROM moment m</span></span><br><span class="line"><span class="string">      LEFT JOIN users u ON m.user_id = u.id </span></span><br><span class="line"><span class="string">      WHERE m.id =?`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [id])</span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>å®šä¹‰æŸ¥è¯¢å¤šæ¡å†…å®¹çš„æ¥å£</p><ul><li><p>æŸ¥è¯¢æ‰€æœ‰momentæ¥å£å†…å®¹ï¼ˆæ ¹æ®offsetå’Œsizeå†³å®šæŸ¥è¯¢æ•°é‡ï¼‰</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># è·¯ç”±</span><br><span class="line"><span class="comment">// æŸ¥çœ‹å¤šæ¡åŠ¨æ€</span></span><br><span class="line">momentRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, list)</span><br></pre></td></tr></table></figure><p>åœ¨å®é™…ä¸­ï¼Œæ•°æ®å¾ˆå¤šçš„ï¼Œä¸èƒ½ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æ•°æ®æŸ¥å®Œè€Œæ˜¯åˆ†é¡µæŸ¥è¯¢ï¼Œæ‰€ä»¥ä½ è¯·æ±‚è·¯å¾„åé¢è¿˜è¦è·Ÿä¸Šåç§»offset+sizeï¼Œä»å“ªå„¿æŸ¥ï¼Œä¸€æ¬¡æŸ¥å¤šå°‘</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">list</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// è·å–æŸ¥è¯¢å‚æ•°</span></span><br><span class="line">    <span class="keyword">const</span> &#123;offset, size&#125; = ctx.<span class="property">request</span>.<span class="property">query</span></span><br><span class="line">    <span class="comment">//è·å–æ•°æ®</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">getMomentList</span>(offset, size)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># æŸ¥è¯¢å¤šæ¡å†…å®¹</span><br><span class="line"> <span class="keyword">async</span> <span class="title function_">getMomentList</span>(<span class="params">offset, size</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT </span></span><br><span class="line"><span class="string">      m.id id, m.content content, </span></span><br><span class="line"><span class="string">      m.createAt createTime, m.updateAt updateTime, </span></span><br><span class="line"><span class="string">      JSON_OBJECT(&#x27;id&#x27;, u.id, &#x27;name&#x27;, u.name) author</span></span><br><span class="line"><span class="string">      FROM moment m</span></span><br><span class="line"><span class="string">      LEFT JOIN users u ON m.user_id = u.id </span></span><br><span class="line"><span class="string">      LIMIT ?, ?`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [offset, size])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li><p>ä»£ç ä¼˜åŒ–ï¼šsqlè¯­å¥æœ‰å¾ˆå¤šç›¸ä¼¼çš„åœ°æ–¹ï¼Œå¯ä»¥æŠ½å‡ºæ¥ ï¼Œç®€åŒ–ä»£ç </p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> sqlFragment = <span class="string">`SELECT </span></span><br><span class="line"><span class="string">  m.id id, m.content content, </span></span><br><span class="line"><span class="string">  m.createAt createTime, m.updateAt updateTime, </span></span><br><span class="line"><span class="string">  JSON_OBJECT(&#x27;id&#x27;, u.id, &#x27;name&#x27;, u.name) author</span></span><br><span class="line"><span class="string">  FROM moment m</span></span><br><span class="line"><span class="string">  LEFT JOIN users u ON m.user_id = u.id `</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> statement = <span class="string">`</span></span><br><span class="line"><span class="string">  <span class="subst">$&#123;sqlFragment&#125;</span></span></span><br><span class="line"><span class="string">	WHERE m.id =?`</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="5-2-ä¿®æ”¹-åˆ é™¤åŠ¨æ€å†…å®¹">5.2 ä¿®æ”¹/åˆ é™¤åŠ¨æ€å†…å®¹<a class="anchor" href="#5-2-ä¿®æ”¹-åˆ é™¤åŠ¨æ€å†…å®¹">Â·</a></h3><h4 id="1-å®šä¹‰ä¿®æ”¹åŠ¨æ€å†…å®¹çš„æ¥å£">1. å®šä¹‰ä¿®æ”¹åŠ¨æ€å†…å®¹çš„æ¥å£<a class="anchor" href="#1-å®šä¹‰ä¿®æ”¹åŠ¨æ€å†…å®¹çš„æ¥å£">Â·</a></h4><p>â€‹	ç”¨æˆ·å¿…é¡»å·²ç»ç™»å½•éªŒè¯; åªèƒ½ä¿®æ”¹è‡ªå·±å‘è¡¨çš„å†…å®¹ï¼Œè€Œä¸èƒ½ä¿®æ”¹åˆ«äººçš„å†…å®¹ï¼Œæ˜¯å¦æœ‰æƒé™</p><ul><li><p>å®šä¹‰è·¯ç”±æ¥å£</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹åŠ¨æ€ </span></span><br><span class="line">momentRouter.<span class="title function_">patch</span>(<span class="string">&#x27;/:momentId&#x27;</span>,verifyAuth, verifyPermission, update)</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ç”¨æˆ·ç™»å½•ï¼šçœç•¥</p></li><li><p>éªŒè¯ç”¨æˆ·çš„æƒé™</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">middleware</span>.<span class="property">js</span>çš„ä¸­é—´ä»¶</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyPermission</span> = <span class="keyword">async</span>(<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// éªŒè¯å·²ç»ç™»é™†çš„ç”¨æˆ·ä¸è¦ä¿®æ”¹çš„è¯„è®ºæ˜¯å¦æœ‰æƒé™</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;éªŒè¯æ˜¯å¦æœ‰ä¿®æ”¹æƒé™&#x27;</span>)</span><br><span class="line"><span class="comment">// 1.è·å–å‚æ•°</span></span><br><span class="line">  <span class="comment">// momentId æ˜¯è¦ä¿®æ”¹çš„åŠ¨æ€id</span></span><br><span class="line">  <span class="keyword">const</span> &#123;momentId&#125; = ctx.<span class="property">request</span>.<span class="property">params</span></span><br><span class="line">  <span class="comment">// æ‹¿åˆ°å½“å‰ç™»å½•ç”¨æˆ·çš„idï¼Œä¹Ÿå°±æ˜¯è°ç™»é™†çš„</span></span><br><span class="line">  <span class="comment">//åœ¨updateå‰é¢çš„ä¸­é—´ä»¶auth.verifyä¸­å°†ctx.user = result</span></span><br><span class="line">  <span class="comment">//å½“å‰ç™»å½•ä¿¡æ¯ç»“æœä¿å­˜åœ¨useré‡Œé¢</span></span><br><span class="line">  <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">user</span></span><br><span class="line"><span class="comment">// 2. æŸ¥è¯¢æ˜¯å¦å…·å¤‡æƒé™å¹¶å¤„ç†</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> isPermission = <span class="keyword">await</span> authService.<span class="title function_">checkMoment</span>(momentId, id)</span><br><span class="line">    <span class="keyword">if</span>(!isPermission)&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>()<span class="comment">//è¿™ä¸ªé”™è¯¯ä¼šåœ¨catchæ•è·</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">  &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NOT_PERMISSION</span>)</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, error, ctx)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><h4 id="å•ç‹¬å°è£…æƒé™æŸ¥è¯¢çš„å‡½æ•°ï¼Œè¿™æ˜¯ä¸ºäº†åç»­å„ç§éœ€è¦æƒé™çš„æ“ä½œæ—¶ï¼Œä¸ç”¨å†é‡å¤å†™">å•ç‹¬å°è£…æƒé™æŸ¥è¯¢çš„å‡½æ•°ï¼Œè¿™æ˜¯ä¸ºäº†åç»­å„ç§éœ€è¦æƒé™çš„æ“ä½œæ—¶ï¼Œä¸ç”¨å†é‡å¤å†™<a class="anchor" href="#å•ç‹¬å°è£…æƒé™æŸ¥è¯¢çš„å‡½æ•°ï¼Œè¿™æ˜¯ä¸ºäº†åç»­å„ç§éœ€è¦æƒé™çš„æ“ä½œæ—¶ï¼Œä¸ç”¨å†é‡å¤å†™">Â·</a></h4><p>éªŒè¯æƒé™çš„ä¸­é—´ä»¶å¾ˆé‡è¦ï¼š</p><ol><li>å¾ˆå¤šåŠŸèƒ½éƒ½éœ€è¦æƒé™éªŒè¯</li><li>ä¸šåŠ¡æ¥å£ï¼Œä¸€èˆ¬åªéœ€è¦éªŒè¯å½“å‰ç™»å½•çš„è¿™ä¸ªäººä¸ä¿®æ”¹è¯„è®ºå³å¯ã€‚ä½†åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæƒé™éªŒè¯æ˜¯éå¸¸é‡è¦çš„ï¼Œå®ƒæ˜¯æœ‰ä¸€å¯¹ä¸€çš„å…³ç³»ï¼šåå°ç®¡ç†ç³»ç»Ÿä¸­ç”¨æˆ·æœ‰è§’è‰²ï¼Œè¿˜æœ‰æƒé™è¡¨ï¼Œæ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚è§’è‰²æ˜¯å¦å…·å¤‡æŸä¸ªæƒé™ï¼Œåˆ°æ—¶å€™å¯ä»¥å»æŸ¥è¯¢å°±å¯ä»¥äº†ã€‚</li><li>å¼€å‘ä¸šåŠ¡æ¥å£å’Œåå°ç®¡ç†ç³»ç»Ÿä¸€èˆ¬æ˜¯ä¸¤ä¸ªç³»ç»Ÿï¼Œè€Œä¸”å¯èƒ½éƒ¨ç½²åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œä¸€èˆ¬ä¸ä¼šæ”¾åœ¨ä¸€èµ·å¼€å‘ã€‚</li></ol><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># auth.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">const</span> connection = <span class="built_in">require</span>(<span class="string">&#x27;../app/database&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">authService</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">checkMoment</span>(<span class="params">momentId, userId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM moment WHERE id =? AND user_id = ?`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [momentId, userId])</span><br><span class="line">    <span class="keyword">return</span> result.<span class="property">length</span> === <span class="number">0</span>? <span class="attr">false</span>:<span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">authService</span>()</span><br></pre></td></tr></table></figure></li><li><p>Controllerå’ŒServiceä¸­çš„å¤„ç†</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line"> <span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// momentId æ˜¯è¦ä¿®æ”¹çš„åŠ¨æ€id</span></span><br><span class="line">    <span class="keyword">const</span> &#123;momentId&#125; = ctx.<span class="property">request</span>.<span class="property">params</span></span><br><span class="line">    <span class="keyword">const</span> &#123;content&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="comment">// ä¿®æ”¹åŠ¨æ€</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">update</span>(content, momentId)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">content, id</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`UPDATE moment SET content =? WHERE id = ?`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [content, id])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-å®šä¹‰åˆ é™¤å†…å®¹çš„æ¥å£">2. å®šä¹‰åˆ é™¤å†…å®¹çš„æ¥å£<a class="anchor" href="#2-å®šä¹‰åˆ é™¤å†…å®¹çš„æ¥å£">Â·</a></h4><ul><li><p>å®šä¹‰è·¯ç”±æ¥å£</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ é™¤åŠ¨æ€</span></span><br><span class="line">momentRouter.<span class="title function_">delete</span>(<span class="string">&#x27;/:momentId&#x27;</span>,verifyAuth, verifyPermission, remove)</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ç”¨æˆ·ç™»å½•ï¼šçœç•¥</p></li><li><p>éªŒè¯ç”¨æˆ·æƒé™ï¼š çœç•¥</p></li><li><p>Controllerå’ŒServiceçš„å¤„ç†</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ°è¦è¾“å‡ºåŠ¨æ€çš„id</span></span><br><span class="line">  <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">momentId</span></span><br><span class="line">  <span class="comment">// åˆ é™¤å†…å®¹</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> momentService.<span class="title function_">remove</span>(id)</span><br><span class="line">  ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`DELETE FROM moment WHERE id = ?`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [id])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="6-1-å‘è¡¨-ä¿®æ”¹è¯„è®ºå†…å®¹">6.1 å‘è¡¨/ä¿®æ”¹è¯„è®ºå†…å®¹<a class="anchor" href="#6-1-å‘è¡¨-ä¿®æ”¹è¯„è®ºå†…å®¹">Â·</a></h3><ul><li><p>åˆ›å»ºæ–°çš„è¡¨ comment</p><p>éœ€è¦è®°å½•æ˜¯å¯¹å½“å‰åŠ¨æ€åšçš„è¯„è®ºï¼Œè¿˜æ˜¯å¯¹è¯„è®ºåšäº†è¯„è®ºï¼Œä½†ä»–ä»¬éƒ½å±äºå½“å‰è¿™æ¡åŠ¨æ€ä¸‹çš„ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">TABLE</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">`comment`</span>(</span><br><span class="line">  # è¯„è®ºå”¯ä¸€çš„ä¸»é”®</span><br><span class="line">  id <span class="variable constant_">INT</span> <span class="variable constant_">PRIMARY</span> <span class="variable constant_">KEY</span> <span class="variable constant_">AUTO_INCREMENT</span>,</span><br><span class="line">  # è¯„è®ºçš„å†…å®¹</span><br><span class="line">  content <span class="title function_">VARCHAR</span>(<span class="number">1000</span>) <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span>,</span><br><span class="line">  # å¯¹å“ªä¸ªåŠ¨æ€åšçš„è¯„è®º</span><br><span class="line">  moment_id <span class="variable constant_">INT</span> <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span>,</span><br><span class="line">  # å“ªä¸ªç”¨æˆ·åšçš„è¯„è®º</span><br><span class="line">  user_id <span class="variable constant_">INT</span> <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span>,</span><br><span class="line">  # è¿™ä¸ªè¯„è®ºæ˜¯å¯¹å“ªä¸ªè¯„è®ºåšçš„è¯„è®º</span><br><span class="line">  comment_id <span class="variable constant_">INT</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">NULL</span>,</span><br><span class="line">  createAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  updateAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line"></span><br><span class="line">  <span class="variable constant_">FOREIGN</span> <span class="variable constant_">KEY</span> (moment_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">moment</span>(id) <span class="variable constant_">ON</span> <span class="variable constant_">DELETE</span> <span class="variable constant_">CASCADE</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CASCADE</span>,</span><br><span class="line">  <span class="variable constant_">FOREIGN</span> <span class="variable constant_">KEY</span> (user_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">users</span>(id) <span class="variable constant_">ON</span> <span class="variable constant_">DELETE</span> <span class="variable constant_">CASCADE</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CASCADE</span>,</span><br><span class="line">  <span class="variable constant_">FOREIGN</span> <span class="variable constant_">KEY</span> (comment_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">comment</span>(id) <span class="variable constant_">ON</span> <span class="variable constant_">DELETE</span> <span class="variable constant_">CASCADE</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CASCADE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li></ul><h4 id="1-å®šä¹‰å‘å¸ƒè¯„è®ºå†…å®¹çš„æ¥å£">1. å®šä¹‰å‘å¸ƒè¯„è®ºå†…å®¹çš„æ¥å£<a class="anchor" href="#1-å®šä¹‰å‘å¸ƒè¯„è®ºå†…å®¹çš„æ¥å£">Â·</a></h4><ul><li><p>å®šä¹‰è·¯ç”±æ¥å£</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/comment.controller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;verifyAuth&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleWare/auth.middleware&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commentRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&quot;/comment&quot;</span>&#125;)</span><br><span class="line">commentRouter.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, verifyAuth, create)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = commentRouter</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ç”¨æˆ·ç™»å½•ï¼š verifyAuthçœç•¥</p></li><li><p>Controllerå’ŒServiceä¸­å¤„ç†å†…å®¹</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&#x27;../service/comment.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">momentController</span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºè¯„è®º</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// åœ¨è¯·æ±‚ä½“é‡Œå¯¹å“ªä¸ªåŠ¨æ€(åŠ¨æ€id)æ‹¿åˆ°è¯„è®ºçš„å†…å®¹(content)</span></span><br><span class="line">    <span class="keyword">const</span> &#123;momentId, content&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="comment">// è°å‘å¸ƒçš„è¯„è®ºï¼Œåœ¨ä¸Šä¸€ä¸ªä¸­é—´ä»¶è®¤è¯ä¸­å·²ç»çŸ¥é“</span></span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">user</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">create</span>(momentId, content, id)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">momentController</span>()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">const</span> connection = <span class="built_in">require</span>(<span class="string">&#x27;../app/database&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">momentService</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">momentId, content, user_id</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO comment (content, moment_id, user_id) </span></span><br><span class="line"><span class="string">    										VALUES (?, ?, ?)`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, </span><br><span class="line">    										[content, momentId, user_id])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">momentService</span>()</span><br></pre></td></tr></table></figure><ul><li>åœ¨è¿™é‡ŒçŠ¯äº†é”™ï¼šå†™sqlè¯­å¥çš„æ—¶å€™ä¸€å®šè¦è®°å¾—å¯¹ç…§æ•°æ®åº“é‡Œé¢çš„ç§°å‘¼åå­—ï¼Œä¼ å‚æ—¶å¯¹åº”å°±å¯ä»¥ï¼Œä½†å†™è¯­å¥æ—¶å¿…é¡»ä¸¥æ ¼ä¸€æ ·</li></ul></li></ul><h4 id="2-å®šä¹‰å›å¤è¯„è®ºå†…å®¹çš„æ¥å£">2. å®šä¹‰å›å¤è¯„è®ºå†…å®¹çš„æ¥å£<a class="anchor" href="#2-å®šä¹‰å›å¤è¯„è®ºå†…å®¹çš„æ¥å£">Â·</a></h4><ul><li><p>å®šä¹‰è·¯ç”±æ¥å£</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">commentRouter.<span class="title function_">post</span>(<span class="string">&#x27;/:commentId/reply&#x27;</span>, verifyAuth, reply)</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ç”¨æˆ·ç™»å½•ï¼š verifyAuth</p></li><li><p>Controllerå’ŒServiceä¸­çš„å¤„ç†</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">reply</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°ä¼ çš„å‚æ•°commentId</span></span><br><span class="line">    <span class="keyword">const</span> &#123;momentId, content&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">const</span> &#123;commentId&#125; = ctx.<span class="property">params</span></span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">user</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">reply</span>(commentId, momentId, content, id)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">reply</span>(<span class="params">commentId, momentId, content, id</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO comment (content, moment_id, user_id, comment_id) 								VALUES (?, ?, ?, ?)`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, </span><br><span class="line">    											[content, momentId, id, 		commentId])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-å®šä¹‰ä¿®æ”¹è¯„è®ºå†…å®¹çš„æ¥å£">3. å®šä¹‰ä¿®æ”¹è¯„è®ºå†…å®¹çš„æ¥å£<a class="anchor" href="#3-å®šä¹‰ä¿®æ”¹è¯„è®ºå†…å®¹çš„æ¥å£">Â·</a></h4><ul><li><p>å®šä¹‰è·¯ç”±æ¥å£</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹è¯„è®º,ä½ åªèƒ½ä¿®æ”¹è‡ªå·±å‘è¡¨çš„è¯„è®ºï¼Œè€Œä¸èƒ½ä¿®æ”¹åˆ«äººå‘è¡¨çš„è¯„è®º</span></span><br><span class="line">commentRouter.<span class="title function_">patch</span>(<span class="string">&#x27;/:commentId&#x27;</span>, verifyAuth, verifyPermission, update)</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ç”¨æˆ·ç™»å½•: verifyAuth</p></li><li><p>éªŒè¯ç”¨æˆ·çš„æƒé™</p><ul><li>ä¹‹å‰çš„æƒé™æ˜¯éªŒè¯æ˜¯å¦å…·å¤‡å‘è¡¨åŠ¨æ€çš„æƒé™ï¼Œè€Œè¿™é‡Œæ˜¯éªŒè¯æ˜¯å¦æœ‰ä¿®æ”¹è¯„è®ºçš„æƒé™ï¼Œæ˜¯ä¸å¯ä»¥ç»§ç»­ç”¨ä»¥å‰çš„é‚£ä¸ªæƒé™çš„</li><li>ä¸€ç§æ€è·¯æ˜¯æŒ‰ä¹‹å‰éªŒè¯åŠ¨æ€æƒé™ä¸€æ ·ï¼Œå†å»å†™ä¸€ä¸ªå‡½æ•°verifyPermissionæ¥éªŒè¯ï¼Œä½†æ˜¯éšç€è¶Šæ¥è¶Šå¤šçš„ä¸šåŠ¡éƒ½éœ€è¦éªŒè¯æ—¶ï¼Œæ­¤æ—¶ä»£ç é‡ä¼šè¶Šæ¥è¶Šå¤šã€‚</li><li>å¦ä¸€ç§è§£å†³åŠæ³•æ˜¯ï¼šå†™ä¸€ä¸ªå‡½æ•°æ—¢å…·å¤‡éªŒè¯åŠ¨æ€ï¼Œä¹Ÿå…·å¤‡éªŒè¯è¯„è®ºã€‚ä½†æ˜¯å¦‚æœä½ åªæ˜¯è°ƒç”¨checkmomentï¼Œé‡Œé¢çš„const statement = <code>SELECT * FROM moment WHERE id =? AND user_id = ?</code>æ˜¯å†™æ­»çš„ï¼Œä½ åªèƒ½éªŒè¯åŠ¨æ€ã€‚æ‰€ä»¥è®©è¿™ä¸ªéªŒè¯æƒé™çš„å‡½æ•°å…·å¤‡å¤šç§éªŒè¯åŠŸèƒ½çš„æ–¹æ³•æ˜¯ï¼šåŠ¨æ€çš„æ”¹å˜statementï¼Œè®©ä»–æŸ¥è¯¢çš„ä¸œè¥¿éšæƒé™çš„ä¸åŒè€Œå˜åŒ–ã€‚</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># å¯¹auth.<span class="property">middleware</span>.<span class="property">js</span>é‡æ–°ä¿®æ”¹  verifyPermissionå‡½æ•°</span><br><span class="line"># æ›´æ”¹äº†checkmomentä¸ºcheckResourceï¼Œå¹¶å¯¹å‚æ•°åšäº†æ”¹å˜</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyPermission</span> = <span class="keyword">async</span>(<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// éªŒè¯å·²ç»ç™»é™†çš„ç”¨æˆ·ä¸è¦ä¿®æ”¹çš„åŠ¨æ€æ˜¯å¦æœ‰æƒé™</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;éªŒè¯æ˜¯å¦æœ‰ä¿®æ”¹æƒé™&#x27;</span>)</span><br><span class="line"><span class="comment">// 1.è·å–å‚æ•°</span></span><br><span class="line">  <span class="comment">// momentId æ˜¯è¦ä¿®æ”¹çš„åŠ¨æ€id</span></span><br><span class="line">  <span class="comment">// const &#123;momentId&#125; = ctx.request.params</span></span><br><span class="line">  <span class="comment">// æ‹¿åˆ°å½“å‰ç™»å½•ç”¨æˆ·çš„idï¼Œä¹Ÿå°±æ˜¯è°ç™»é™†çš„</span></span><br><span class="line">  <span class="comment">//åœ¨updateå‰é¢çš„ä¸­é—´ä»¶auth.verifyä¸­å°†ctx.user = result</span></span><br><span class="line">  <span class="comment">//å½“å‰ç™»å½•ä¿¡æ¯ç»“æœä¿å­˜åœ¨useré‡Œé¢</span></span><br><span class="line">    <span class="comment">// è·å–tablename:</span></span><br><span class="line">    <span class="comment">//æ€è·¯1ï¼š</span></span><br><span class="line">    <span class="comment">//æ€è·¯2ï¼šå¦‚æœè·¯å¾„æ˜¯restfulé£æ ¼ï¼Œå¯ä»¥ä»é‡Œé¢å–å‡ºtableNmae</span></span><br><span class="line">    <span class="keyword">const</span> [resourceKey] = <span class="title class_">Object</span>.<span class="title function_">keys</span>(ctx.<span class="property">params</span>)</span><br><span class="line">    <span class="keyword">const</span> tableName = resourceKey.<span class="title function_">replace</span>(<span class="string">&#x27;Id&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="comment">//resourceIdæ˜¯æƒ³ä¿®æ”¹çš„é‚£ä¸ªè¯„è®ºåœ¨tableä¸­æ‰€å¤„çš„idå·</span></span><br><span class="line">    <span class="keyword">const</span> resourceId = ctx.<span class="property">params</span>[resourceKey]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">user</span></span><br><span class="line"><span class="comment">// 2. æŸ¥è¯¢æ˜¯å¦å…·å¤‡æƒé™å¹¶å¤„ç†</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> isPermission = <span class="keyword">await</span> authService.<span class="title function_">checkResource</span>(tableName,resourceId, id)</span><br><span class="line">    <span class="keyword">if</span>(!isPermission)&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>()<span class="comment">//è¿™ä¸ªé”™è¯¯ä¼šåœ¨catchæ•è·</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¿…é¡»åŠ awaitï¼Œå¦åˆ™ä¼šå‡ºé—®é¢˜ï¼Œä¸ºä»€ä¹ˆ</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">  &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">    <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="title class_">Error</span>(errorType.<span class="property">NOT_PERMISSION</span>)</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, error, ctx)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># auth.<span class="property">service</span>.<span class="property">js</span>ä¿®æ”¹å</span><br><span class="line"><span class="keyword">const</span> connection = <span class="built_in">require</span>(<span class="string">&#x27;../app/database&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">authService</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">checkResource</span>(<span class="params">tableNmae, id, userId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM <span class="subst">$&#123;tableNmae&#125;</span> WHERE id =? AND user_id = ?`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [id, userId])</span><br><span class="line">    <span class="keyword">return</span> result.<span class="property">length</span> === <span class="number">0</span>? <span class="attr">false</span>:<span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">authService</span>()</span><br></pre></td></tr></table></figure><ul><li><p>Controllerå’ŒServiceä¸­çš„å¤„ç†</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">	<span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;content&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">const</span> &#123;commentId&#125; = ctx.<span class="property">params</span></span><br><span class="line">    <span class="comment">// ä¿®æ”¹è¯„è®º</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">update</span>(content, commentId)</span><br><span class="line">    ctx.<span class="property">body</span> = content+commentId+result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">content, commentId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`UPDATE comment SET content=? WHERE comment_id = ?`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [content, commentId])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="6-2-åˆ é™¤-æŸ¥è¯¢è¯„è®ºå†…å®¹">6.2 åˆ é™¤/æŸ¥è¯¢è¯„è®ºå†…å®¹<a class="anchor" href="#6-2-åˆ é™¤-æŸ¥è¯¢è¯„è®ºå†…å®¹">Â·</a></h3><h4 id="1-å®šä¹‰åˆ é™¤è¯„è®ºå†…å®¹çš„æ¥å£">1. å®šä¹‰åˆ é™¤è¯„è®ºå†…å®¹çš„æ¥å£<a class="anchor" href="#1-å®šä¹‰åˆ é™¤è¯„è®ºå†…å®¹çš„æ¥å£">Â·</a></h4><ul><li><p>å®šä¹‰è·¯ç”±æ¥å£</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ é™¤è¯„è®º</span></span><br><span class="line">commentRouter.<span class="title function_">delete</span>(<span class="string">&#x27;/:commentId&#x27;</span>, verifyAuth, verifyPermission, remove)</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ç”¨æˆ·ç™»å½•ï¼šverifyAuth</p></li><li><p>éªŒè¯ç”¨æˆ·æƒé™ï¼šverifyPermission</p></li><li><p>Controllerå’ŒServiceçš„å¤„ç†</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// åˆ é™¤è¯„è®ºéœ€è¦è¿™ä¸ªè¯„è®ºçš„idå³å¯</span></span><br><span class="line">    <span class="keyword">const</span> &#123;commentId&#125; = ctx.<span class="property">params</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">delete</span>(commentId)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">delete</span>(<span class="params">commentId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`DELETE FROM comment WHERE id=? `</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [commentId])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-æŸ¥è¯¢åŠ¨æ€">2. æŸ¥è¯¢åŠ¨æ€<a class="anchor" href="#2-æŸ¥è¯¢åŠ¨æ€">Â·</a></h4><ul><li><p>éœ€æ±‚ï¼š</p><ul><li><p>æŸ¥è¯¢ä¸€ä¸ªåŠ¨æ€è¯¦æƒ…æ—¶ï¼Œæ—¢è¦çœ‹åŠ¨æ€ä¿¡æ¯ï¼Œè¿˜è¦çœ‹ç”¨æˆ·ä¿¡æ¯ï¼Œè¯„è®ºçš„åˆ—è¡¨ã€‚éœ€è¦å›å¤´ä¿®æ”¹moment.user.éœ€è¦ä¿®æ”¹sqlè¯­å¥</p></li><li><p>æŸ¥è¯¢åŠ¨æ€åˆ—è¡¨æ—¶ï¼Œæœ‰ä¸€ä¸ªcommentCountï¼Œä¹Ÿå°±æ˜¯å¯¹åº”ç€ä½ è¿™æ¡åŠ¨æ€ä¸‹æœ‰å¤šå°‘æ¡è¯„è®ºè®¡æ•°ã€‚</p></li></ul></li><li><p>æŸ¥è¯¢å¤šä¸ªåŠ¨æ€æ—¶ï¼Œ<strong>æ˜¾ç¤ºè¯„è®ºçš„ä¸ªæ•°</strong></p><p>åœ¨åŸæœ‰çš„æŸ¥çœ‹åŠ¨æ€getMomentListä¸‹çš„åŸºç¡€ä¸Šï¼Œå¯¹sqlè¯­å¥è¿›è¡Œäº†ä¿®æ”¹ï¼Œæ·»åŠ æŸ¥è¯¢å­—æ®µï¼Œå¹¶å¢æ·»äº†è¯„è®ºæ•°é‡</p><p>åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ æŸ¥è¯¢å­—æ®µï¼Œå­æŸ¥è¯¢å­—æ®µã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> </span><br><span class="line">  m.<span class="property">id</span> id, m.<span class="property">content</span> content, </span><br><span class="line">  m.<span class="property">createAt</span> createTime, m.<span class="property">updateAt</span> updateTime, </span><br><span class="line">  <span class="title class_">JSON</span>_OBJECT(<span class="string">&#x27;id&#x27;</span>, u.<span class="property">id</span>, <span class="string">&#x27;name&#x27;</span>, u.<span class="property">name</span>) author,</span><br><span class="line">	(<span class="variable constant_">SELECT</span> <span class="title function_">COUNT</span>(*) <span class="variable constant_">FROM</span> comment c <span class="variable constant_">WHERE</span> c.<span class="property">moment_id</span> = m.<span class="property">id</span>) commentCount</span><br><span class="line">  <span class="variable constant_">FROM</span> moment m</span><br><span class="line">  <span class="variable constant_">LEFT</span> <span class="variable constant_">JOIN</span> users u <span class="variable constant_">ON</span> m.<span class="property">user_id</span> = u.<span class="property">id</span></span><br><span class="line">	<span class="variable constant_">LIMIT</span> ?, ?;</span><br></pre></td></tr></table></figure><ul><li><p>è¿›è¡Œè¯·æ±‚ï¼š <img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210208223358740.png" alt="image-20210208223358740"></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;content&quot;</span>: <span class="string">&quot;è¯„è®ºåŠ¨æ€çš„å†…å®¹&quot;</span>,</span><br><span class="line">        <span class="string">&quot;createTime&quot;</span>: <span class="string">&quot;2021-02-07T09:33:56.000Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;updateTime&quot;</span>: <span class="string">&quot;2021-02-07T09:33:56.000Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;author&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;lucy&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;commentCount&quot;</span>: <span class="number">4</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">&quot;content&quot;</span>: <span class="string">&quot;è¯„è®ºåŠ¨æ€çš„å†…å®¹&quot;</span>,</span><br><span class="line">        <span class="string">&quot;createTime&quot;</span>: <span class="string">&quot;2021-02-07T09:34:48.000Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;updateTime&quot;</span>: <span class="string">&quot;2021-02-07T09:34:48.000Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;author&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;lucy&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;commentCount&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>æ•°æ®åº“ä¸­æ˜¾ç¤ºæŸ¥è¯¢ç»“æœï¼š <img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210208223616477.png" alt="image-20210208223616477"></p></li></ul></li><li><p>æŸ¥è¯¢å•ä¸ªåŠ¨æ€æ—¶ï¼Œæ˜¾ç¤ºè¯„è®ºçš„åˆ—è¡¨</p><p>å½“ç”¨æˆ·ç‚¹å‡»åŠ¨æ€åï¼Œä¼šè¿›å…¥åŠ¨æ€è¯¦æƒ…é¡µã€‚å¦‚ä½•è·å–è¯„è®ºçš„åˆ—è¡¨ï¼Œä¹‹å‰æ˜¯è¯„è®ºæ•°é‡</p><ul><li>æ€è·¯1ï¼šåŠ¨æ€çš„æ¥å£ä¸è¯„è®ºæ¥å£åˆ†å¼€ï¼Œåˆ†åˆ«ç”¨ä¸åŒçš„æ¥å£è·å¾—ä¸åŒçš„éœ€æ±‚</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">router</span>.<span class="property">js</span></span><br><span class="line"><span class="comment">// è·å–è¯„è®ºåˆ—è¡¨ï¼šä¸éœ€è¦éªŒè¯ç™»å½•ã€æƒé™</span></span><br><span class="line">commentRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, list)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">list</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°è¦è·å–commentçš„åŠ¨æ€idï¼šmomentId</span></span><br><span class="line">    <span class="keyword">const</span> &#123;momentId&#125; = ctx.<span class="property">query</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">getCommentsBymomentId</span>(momentId)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># comment.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getCommentsBymomentId</span>(<span class="params">momentId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM comment  WHERE moment_id = ?`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">exexute</span>(statement, [momentId])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210208231911140.png" alt="image-20210208231911140"></p><ul><li>æ€è·¯2ï¼šç›´æ¥åœ¨è¯·æ±‚åŠ¨æ€çš„æ¥å£æ—¶å€™ï¼Œå°±ä¼šæºå¸¦è¯„è®ºç›¸å…³çš„ä¿¡æ¯ï¼ŒåµŒå…¥åŠ¨æ€ä¿¡æ¯é‡Œé¢ã€‚ç¼ºç‚¹ï¼šsqlè¯­å¥å¤æ‚ï¼Œå®¹æ˜“å†™é”™ï¼›å¦‚æœä¿¡æ¯å¾ˆå¤šï¼Œä¸€æ¬¡æ€§è¯·æ±‚è¿‡å¤šçš„ä¿¡æ¯ï¼Œç½‘é€Ÿæ…¢ï¼Œç”¨æˆ·ä½“éªŒä¸å¥½ï¼Œå¯ä»¥æŠŠç”¨æˆ·çš„åŠ¨æ€å…ˆè¯·æ±‚è¿‡æ¥ã€‚çœç•¥</li><li>ç‚¹èµåŠŸèƒ½ï¼šç”¨æˆ·ä¹‹é—´çš„å¤šå¯¹å¤šçš„å…³ç³»ï¼Œä¸€ä¸ªåŠ¨æ€å¯ä»¥è¢«å¤šä¸ªç”¨æˆ·ç‚¹èµï¼Œä¸€ä¸ªç”¨æˆ·ä¹Ÿå¯ä»¥ç‚¹èµå¤šä¸ªç”¨æˆ·ã€‚åŠ¨æ€è¡¨ä¸­æœ‰å¾ˆå¤šåŠ¨æ€ï¼Œç”¨æˆ·è¡¨ä¹Ÿæœ‰å¾ˆå¤šç”¨æˆ·ï¼Œåœ¨è¿™ä¸¤ä¸ªä¹‹é—´å»ºç«‹å…³ç³»è¡¨ï¼ŒæŠŠåŠ¨æ€ç›¸å…³çš„id+user_idç»“åˆåœ¨ä¸€èµ·ç½‘è¿™ä¸ªè¡¨æ’å…¥è¿›å»ã€‚</li></ul></li></ul><h3 id="7-æ ‡ç­¾æ¥å£å¼€å‘ï¼ˆå¤šå¯¹å¤šï¼‰">7. æ ‡ç­¾æ¥å£å¼€å‘ï¼ˆå¤šå¯¹å¤šï¼‰<a class="anchor" href="#7-æ ‡ç­¾æ¥å£å¼€å‘ï¼ˆå¤šå¯¹å¤šï¼‰">Â·</a></h3><p>æ ‡ç­¾æ˜¯ç»™åŠ¨æ€åŠ æ ‡ç­¾ï¼Œæ¯ä¸ªåŠ¨æ€éƒ½æœ‰å¯¹åº”ç€ã€‚æ‰€ä»¥éœ€è¦æ ‡ç­¾è¡¨è®°å½•æ ‡ç­¾idï¼Œæ ‡ç­¾åç­‰ã€‚ä¸€ä¸ªåŠ¨æ€å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œä¸€ä¸ªæ ‡ç­¾å¯ä»¥å±äºå¤šä¸ªåŠ¨æ€ã€‚å¤šå¯¹å¤šçš„å…³ç³»ï¼Œæ‰€ä»¥å½“ç»™ä¸€æ¡åŠ¨æ€æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ä»¥åï¼Œå…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ ‡ç­¾ï¼Œæ²¡æœ‰è¦å…ˆåˆ›å»ºï¼Œæœ‰äº†å†æ·»åŠ ã€‚</p><ul><li><p>åˆ›å»ºæ ‡ç­¾çš„è¡¨</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">TABLE</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">`label`</span>(</span><br><span class="line">	 # idæ˜¯ä¸»é”®</span><br><span class="line">	id <span class="variable constant_">INT</span> <span class="variable constant_">PRIMARY</span> <span class="variable constant_">KEY</span> <span class="variable constant_">AUTO_INCREMENT</span>,</span><br><span class="line">	# æ ‡ç­¾å æ˜¯ä¸èƒ½é‡å¤çš„ï¼Œæ²¡æ„ä¹‰</span><br><span class="line">	name <span class="title function_">VARCHAR</span>(<span class="number">10</span>) <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span> <span class="variable constant_">UNIQUE</span>,</span><br><span class="line">	createAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">	updateAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span> </span><br><span class="line">					 <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li></ul><h4 id="1-åˆ›å»ºæ ‡ç­¾æ¥å£">1. åˆ›å»ºæ ‡ç­¾æ¥å£<a class="anchor" href="#1-åˆ›å»ºæ ‡ç­¾æ¥å£">Â·</a></h4><ul><li><p>è·¯ç”±é…ç½®Router</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; verifyAuth &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleWare/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/label.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> labelRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/label&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæ ‡ç­¾æ—¶ä¼šå…ˆéªŒè¯ç™»å½•ï¼Œ</span></span><br><span class="line">labelRouter.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, verifyAuth,create)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = labelRouter</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ç”¨æˆ·ç™»å½•ï¼šverifyAuth</p></li><li><p>Controllerå’ŒServiceçš„å¤„ç†ï¼šåˆ›å»ºæ ‡ç­¾</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># label.<span class="property">controller</span></span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&#x27;../service/label.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">laberController</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°è¦æ·»åŠ çš„æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">const</span> &#123;name&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">create</span>(name)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">laberController</span>()</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># label.<span class="property">service</span></span><br><span class="line"><span class="keyword">const</span> connection = <span class="built_in">require</span>(<span class="string">&quot;../app/database&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">labelService</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">name</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO label (name) VALUES (?);`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [name])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">labelService</span>()</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæ ‡ç­¾å’ŒåŠ¨æ€å…³ç³»è¡¨</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">TABLE</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">`moment_label`</span>(</span><br><span class="line">	moment_id <span class="variable constant_">INT</span> <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span>,</span><br><span class="line">	label_id <span class="variable constant_">INT</span> <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span>,</span><br><span class="line">	createAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">	updateAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">	<span class="comment">// è®©äºŒè€…æˆä¸ºè”åˆä¸»é”®ï¼Œä¸å¤åˆä¸»é”®æ˜¯ä¸€ä¸ªæ¦‚å¿µ</span></span><br><span class="line">	<span class="variable constant_">PRIMARY</span> <span class="variable constant_">KEY</span> (moment_id, label_id),</span><br><span class="line">	<span class="comment">// è¿™é‡Œçš„è”åŠ¨æ•ˆæœæ˜¯ï¼šè¿™æ¡åŠ¨æ€åˆ æ‰äº†ï¼Œå…³ç³»è¡¨é‡Œçš„è®°å½•ä¼šåˆ æ‰ï¼Œä½†æ˜¯æ ‡ç­¾nameå¹¶ä¸ä¼šè¢«åˆ æ‰,</span></span><br><span class="line">	<span class="variable constant_">FOREIGN</span> <span class="variable constant_">KEY</span> (moment_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">moment</span>(id) <span class="variable constant_">ON</span> <span class="variable constant_">DELETE</span> <span class="variable constant_">CASCADE</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CASCADE</span>,</span><br><span class="line">	<span class="variable constant_">FOREIGN</span> <span class="variable constant_">KEY</span> (label_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">label</span>(id) <span class="variable constant_">ON</span> <span class="variable constant_">DELETE</span> <span class="variable constant_">CASCADE</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CASCADE</span></span><br><span class="line">	);</span><br></pre></td></tr></table></figure></li></ul><h4 id="2-ç»™åŠ¨æ€æ·»åŠ æ ‡ç­¾">2. ç»™åŠ¨æ€æ·»åŠ æ ‡ç­¾<a class="anchor" href="#2-ç»™åŠ¨æ€æ·»åŠ æ ‡ç­¾">Â·</a></h4><ul><li><p>ç»™<strong>åŠ¨æ€</strong>æ·»åŠ æ–°çš„æ¥å£ï¼š /moment/1/labels</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">router</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">const</span> &#123;verifyLabelExist&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleWare/label.middleware&#x27;</span>)</span><br><span class="line"><span class="comment">// ç»™åŠ¨æ€æ·»åŠ æ ‡ç­¾</span></span><br><span class="line">momentRouter.<span class="title function_">post</span>(<span class="string">&#x27;/:momentId/labels&#x27;</span>, verifyAuth, verifyPermission,</span><br><span class="line">                    verifyLabelExist,addLabels)</span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯ç”¨æˆ·ç™»å½•ï¼šverifyAuth</p></li><li><p>éªŒè¯ç”¨æˆ·æƒé™ï¼šverifyPermission</p></li><li><p>éªŒè¯æ ‡ç­¾æ˜¯å¦å­˜åœ¨ï¼šControllerå’ŒServiceçš„å¤„ç†</p><p>å¦‚æœæ ‡ç­¾ä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ°labelè¡¨ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸ºlabelåˆ›å»ºæ–°æ ‡ç­¾ã€‚è€Œä¸‹é¢çš„åˆ›å»ºæ ‡ç­¾æ˜¯åœ¨å…³ç³»è¡¨ä¸­æ·»åŠ æ ‡ç­¾</p><ul><li>è¿™é‡Œæ˜¯ä¸å¯ä»¥ç›´æ¥å°†æ ‡ç­¾ä¸åŠ¨æ€è”ç³»åœ¨ä¸€èµ·çš„ï¼Œæ ‡ç­¾çš„åå­—æœ‰å¯èƒ½åœ¨æ ‡ç­¾çš„è¡¨é‡Œæ˜¯ä¸å­˜åœ¨çš„ï¼Œæ­¤æ—¶æ˜¯æ²¡æœ‰å¯¹åº”çš„idï¼Œæ­¤æ—¶è”ç³»è¡¨label_idå°±ä¸å­˜åœ¨</li><li>æ‰€ä»¥å½“ç”¨æˆ·è°ƒç”¨æ¥å£æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ ‡ç­¾ï¼Œå¦‚æœä¸å­˜åœ¨å…ˆåˆ›å»ºè¿™ä¸ªæ ‡ç­¾ï¼Œå†å¾€å…³ç³»è¡¨é‡Œé¢æ’å…¥æ•°æ®ã€‚</li><li>æ‰€ä»¥è·¯ç”±ä¸­é—´è¿˜åº”è¯¥æœ‰ä¸€ä¸ªä¸­é—´ä»¶labelmiddleware,é‡Œé¢æœ‰å‡½æ•°varifyLabelExistsï¼ŒéªŒè¯æ ‡ç­¾æ˜¯å¦å­˜åœ¨</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># label.<span class="property">middleware</span>.<span class="property">js</span></span><br><span class="line"><span class="comment">// éªŒè¯è¦æ·»åŠ çš„æ ‡ç­¾æ˜¯å¦å·²ç»å­˜åœ¨ä¸æ ‡ç­¾è¡¨</span></span><br><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&#x27;../service/label.service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyLabelExist</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">//å–å‡ºè¦æ·»åŠ çš„æ‰€æœ‰æ ‡ç­¾</span></span><br><span class="line">  <span class="keyword">const</span> &#123;labels&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">  <span class="keyword">const</span> newLabels = []</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ¯ä¸ªæ ‡ç­¾æ˜¯å¦å­˜åœ¨äºæ ‡ç­¾è¡¨ï¼Œéå†</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> name <span class="keyword">of</span> labels)&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥æ ‡ç­¾ä¸å­˜åœ¨ï¼Œè¿”å›ç»“æœæ˜¯result[0]ï¼Œä¸ºundefined</span></span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨ï¼šç»“æœæ˜¯:BinaryRow &#123;</span></span><br><span class="line">    <span class="comment">//   id: 2,</span></span><br><span class="line">    <span class="comment">//   name: &#x27;æ¸¸æˆ&#x27;,</span></span><br><span class="line">    <span class="comment">//   createAt: 2021-02-09T10:00:56.000Z,</span></span><br><span class="line">    <span class="comment">//   updateAt: 2021-02-09T10:00:56.000Z</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">const</span> labelResult = <span class="keyword">await</span> service.<span class="title function_">getLabelByName</span>(name) <span class="comment">//  label.service.js</span></span><br><span class="line">    <span class="keyword">const</span> label = &#123;name&#125;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨,å°±æ·»åŠ æ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">if</span>(!labelResult)&#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">create</span>(name)   <span class="comment">//  label.service.js</span></span><br><span class="line">      label.<span class="property">id</span> = result.<span class="property">insertId</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      label.<span class="property">id</span> = labelResult.<span class="property">id</span></span><br><span class="line">    &#125;</span><br><span class="line">    newLabels.<span class="title function_">push</span>(label)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¾ªç¯ç»“æŸï¼Œå®Œæˆæ‰€æœ‰ä¸å­˜åœ¨æ ‡ç­¾çš„æ·»åŠ åˆ°labelè¡¨</span></span><br><span class="line">  ctx.<span class="property">body</span> = newLabels</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  verifyLabelExist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># label.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">const</span> connection = <span class="built_in">require</span>(<span class="string">&quot;../app/database&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">labelService</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">name</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO label (name) VALUES (?);`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [name])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ ‡ç­¾æ˜¯å¦å­˜åœ¨çš„æƒ…å†µ</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getLabelByName</span>(<span class="params">name</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM label WHERE name = ?`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [name])</span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">labelService</span>()</span><br></pre></td></tr></table></figure></li><li><p>åœ¨å…³ç³»è¡¨ä¸­æ·»åŠ æ ‡ç­¾ï¼šControllerå’ŒServiceçš„å¤„ç†</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">controller</span>.<span class="property">js</span> </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">addLabels</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">//1. ç»™å“ªæ¡åŠ¨æ€ä¸ŠåŠ ä»€ä¹ˆæ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">const</span> &#123;labels&#125; = ctx</span><br><span class="line">    <span class="keyword">const</span> &#123;momentId&#125; = ctx.<span class="property">params</span></span><br><span class="line">    <span class="comment">//2. åˆ¤æ–­ï¼šå¦‚æœæ·»åŠ æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨å…³ç³»è¡¨</span></span><br><span class="line">      <span class="comment">// 2.1 åœ¨å…³ç³»è¡¨ä¸­æ˜¯å¦å…³äºè¿™ä¸ªmomentçš„æ ‡ç­¾å·²ç»æœ‰äº†</span></span><br><span class="line">      <span class="comment">// æ ‡ç­¾è¡¨ã€å…³ç³»è¡¨ä¸­æ ‡ç­¾éƒ½åº”è¯¥æ˜¯å”¯ä¸€çš„</span></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">let</span> label <span class="keyword">of</span> labels)&#123;</span><br><span class="line">        <span class="keyword">const</span> isExist = <span class="keyword">await</span> momentService.<span class="title function_">hasLabel</span>(momentId, label.<span class="property">id</span>)</span><br><span class="line">        <span class="keyword">if</span>(!isExist)&#123;</span><br><span class="line">         <span class="keyword">await</span> momentService.<span class="title function_">addLabels</span>(label.<span class="property">id</span>, momentId)</span><br><span class="line">        &#125; </span><br><span class="line">      &#125;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;åœ¨å…³ç³»è¡¨ä¸­æ·»åŠ æ ‡ç­¾&#x27;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># moment.<span class="property">service</span>.<span class="property">js</span> </span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">hasLabel</span>(<span class="params">momentId, labelId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM moment_label WHERE moment_id=? AND label_id=?`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [momentId, labelId])</span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>]? <span class="attr">true</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">addLabels</span>(<span class="params">label_id, momentId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO moment_label (moment_id, label_id) VALUES (?, ?)`</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [momentId, label_id])</span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="3-å±•ç¤ºæ ‡ç­¾">3. å±•ç¤ºæ ‡ç­¾<a class="anchor" href="#3-å±•ç¤ºæ ‡ç­¾">Â·</a></h4><ul><li><p>å±•ç¤ºæ ‡ç­¾çš„æ¥å£</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŸ¥è¯¢æ ‡ç­¾åˆ—è¡¨</span></span><br><span class="line">labelRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, list)</span><br></pre></td></tr></table></figure></li><li><p><strong>æŸ¥è¯¢åŠ¨æ€åˆ—è¡¨</strong>ï¼Œå±•ç¤º<strong>æ ‡ç­¾æ•°é‡</strong></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># label.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">list</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> &#123;offset, limit&#125; = ctx.<span class="property">query</span></span><br><span class="line">   <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">getLabels</span>(offset, limit)</span><br><span class="line">   ctx.<span class="property">body</span> = result</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># label.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getLabels</span>(<span class="params">offset, limit</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM label LIMIT ?, ?`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [offset, limit])</span><br><span class="line">    <span class="keyword">return</span> result  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹æ ‡ç­¾æ¥å£ï¼šä¸€èˆ¬æ ‡ç­¾åˆ›å»ºåä¸€èˆ¬ä¸ä¼šåšä¿®æ”¹å’Œåˆ é™¤æ“ä½œ</p></li><li><p>æŸ¥è¯¢<strong>åŠ¨æ€è¯¦æƒ…</strong>ï¼Œå±•ç¤º<strong>æ ‡ç­¾åˆ—è¡¨</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlè¯­å¥å¤ªå¤æ‚äº†ï¼Œæš‚æ—¶å…ˆä¸å†™è¿™å—</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210209225206649.png" alt="image-20210209225206649"></p></li></ul><h3 id="8-ä¸Šä¼ å›¾ç‰‡">8. ä¸Šä¼ å›¾ç‰‡<a class="anchor" href="#8-ä¸Šä¼ å›¾ç‰‡">Â·</a></h3><h4 id="åˆ†æå®ç°æ€è·¯ï¼š">åˆ†æå®ç°æ€è·¯ï¼š<a class="anchor" href="#åˆ†æå®ç°æ€è·¯ï¼š">Â·</a></h4><ul><li><p>å›¾ç‰‡ï¼ˆæ–‡ä»¶ï¼‰ä¸Šä¼  /upload/avatar</p><ul><li>å›¾ç‰‡ä¸Šä¼ å°±æ˜¯æ–‡ä»¶ä¸Šä¼ çš„ä¸€ç§ï¼ŒæœåŠ¡å™¨ç«¯å¯ä»¥ä¿å­˜ä¸€å¼ å›¾ç‰‡</li></ul></li><li><p>æä¾›ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥è®©ç”¨æˆ·è·å–å›¾ç‰‡</p><ul><li><p>å¦‚æœæœ‰ä¸€å¤©æµè§ˆå™¨è¯·æ±‚è¿™ä¸ªå›¾ç‰‡æ—¶ï¼Œè¦åœ¨imgæ ‡ç­¾é‡Œå±•ç¤ºå‡ºæ¥å›¾ç‰‡ã€‚å¿…é¡»æä¾›ä¸€ä¸ªæ¥å£æä¾›ç»™ç”¨æˆ·è·å–è¿™ä¸ªæ¥å£ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·ä¸‹è½½è¿™ä¸ªå›¾ç‰‡æ–‡ä»¶ã€‚</p></li><li><p>æ‰¾åˆ°å›¾ç‰‡ï¼Œè¯»å–å›¾ç‰‡ï¼Œè®¾ç½®content-typeï¼Œå‘Šè¯‰æµè§ˆå™¨ç±»å‹ï¼Œè€Œä¸æ˜¯å°†äºŒè¿›åˆ¶æµç›´æ¥ç»™ä»–ã€‚è¿™æ ·æµè§ˆå™¨æ‰çŸ¥é“æ˜¯ä¸€å›¾ç‰‡çš„å½¢å¼å±•ç¤ºå‡ºå»</p></li><li><p>avatar -&gt; æ‰¾åˆ°å›¾ç‰‡\è¯»å–å›¾ç‰‡\content-type: image/jpeg\è¿”å›å›¾åƒçš„ä¿¡æ¯</p></li></ul></li><li><p>å°†URLå­˜å‚¨åˆ°ç”¨æˆ·ä¿¡æ¯ä¸­</p><ul><li><p>å°†urlå­˜å‚¨åˆ°ç”¨æˆ·ä¿¡æ¯ä¸­ï¼Œç”¨æˆ·ä¿¡æ¯ä¸­æœ‰ä¸€ä¸ªå­—æ®µï¼š avatarå­—æ®µï¼Œç›´æ¥ç»™ç”¨æˆ·å¤´åƒçš„åœ°å€</p></li><li><p>avatarURL: å¤´åƒçš„åœ°å€</p></li></ul></li><li><p>è·å–ä¿¡æ¯æ—¶ï¼Œè·å–ç”¨æˆ·çš„å¤´åƒ</p></li></ul><h4 id="1-ä¸Šä¼ å¤´åƒ">1. ä¸Šä¼ å¤´åƒ<a class="anchor" href="#1-ä¸Šä¼ å¤´åƒ">Â·</a></h4><ul><li>å®šä¹‰æ‰€æœ‰å…³äºä¸Šä¼ å¤´åƒçš„æ¥å£</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># file.<span class="property">router</span>.<span class="property">js</span>   å¸Œæœ›åœ¨è¿™ä¸ªè·¯ç”±é‡Œå®šä¹‰æ‰€æœ‰å…³äºå›¾ç‰‡ä¸Šä¼ çš„è·¯ç”±</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;verifyAuth&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleWare/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;uploadHandle&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleWare/file.middleware&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fileRouter = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&quot;/upload&quot;</span>&#125;)</span><br><span class="line"><span class="comment">// ä¸Šä¼ å›¾ç‰‡ï¼šä¸­é—´ä»¶å®šä¹‰å›¾ç‰‡ä¿å­˜åœ¨å“ªé‡Œï¼Œä¿å­˜åœ¨æœåŠ¡å™¨é‡Œï¼›</span></span><br><span class="line"><span class="comment">// å…³äºå›¾ç‰‡çš„ä¿¡æ¯ï¼šç±»å‹ï¼Œå¤§å°ï¼Œcontroller.jsé‡Œ</span></span><br><span class="line"><span class="comment">// ä¸Šä¼ å¤´åƒå¿…é¡»è¦ç™»å½•çš„ï¼ŒverifyAuth, éªŒè¯ç™»å½•</span></span><br><span class="line">fileRouter.<span class="title function_">post</span>(<span class="string">&#x27;/avatar&#x27;</span>, verifyAuth, uploadHandle,saveAvatarInfo)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = fileRouter</span><br></pre></td></tr></table></figure><img src="C:\Users\å°è™ç‰™\AppData\Roaming\Typora\typora-user-images\image-20210210153519583.png" alt="image-20210210153519583" style="zoom:50%"><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># file.<span class="property">middleware</span>.<span class="property">js</span>   å€ŸåŠ©æ’ä»¶koa-multeræ¥å®ç°æ–‡ä»¶ä¸Šä¼ </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Multer</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-multer&#x27;</span>)</span><br><span class="line"><span class="comment">// åœ¨æœ¬åœ°çš„process.cwdè·¯å¾„ä¸‹åˆ›å»ºè·¯å¾„./uploads/avatarä¸‹çš„æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="keyword">const</span> uploadAvatar = <span class="title class_">Multer</span>(&#123;</span><br><span class="line">  <span class="attr">dest</span>: <span class="string">&#x27;./uploads/avatar&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// æ‰¾åˆ°åœ¨postmané‚£è¾¹ä¸Šä¼ çš„avatarå­—æ®µ,singleåªæ‰¾ä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="comment">// ç„¶åæ”¾å…¥åé¢çš„è·¯ç”±åé¢ï¼Œç™»é™†ä¹‹åä¼šå¯¹ä¸Šä¼ æ–‡ä»¶è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="keyword">const</span> uploadHandle = uploadAvatar.<span class="title function_">single</span>(<span class="string">&#x27;avatar&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  uploadHandle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æ–‡ä»¶å¤¹å·²ç»æœ‰ä¸Šä¼ è¿‡æ¥çš„å›¾ç‰‡äº†</p><img src="C:\Users\å°è™ç‰™\AppData\Roaming\Typora\typora-user-images\image-20210210153559449.png" alt="image-20210210153559449" style="zoom:50%"><ul><li><p>å¯¹ä¸Šä¼ å›¾ç‰‡ä¿¡æ¯ä¿å­˜</p><ul><li><p>æ–°å»ºè¡¨avatar</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">TABLE</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">`avatar`</span>(</span><br><span class="line">	id <span class="variable constant_">INT</span> <span class="variable constant_">PRIMARY</span> <span class="variable constant_">KEY</span> <span class="variable constant_">AUTO_INCREMENT</span>,</span><br><span class="line">	filename <span class="title function_">VARCHAR</span>(<span class="number">255</span>) <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span> <span class="variable constant_">UNIQUE</span>,</span><br><span class="line">	mimetype <span class="title function_">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line">	size <span class="variable constant_">INT</span>,</span><br><span class="line">	user_id <span class="variable constant_">INT</span>,</span><br><span class="line">	createAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">	<span class="variable constant_">FOREIGN</span> <span class="variable constant_">KEY</span> (user_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">users</span>(id) <span class="variable constant_">ON</span> <span class="variable constant_">DELETE</span> <span class="variable constant_">CASCADE</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CASCADE</span></span><br><span class="line">	);</span><br></pre></td></tr></table></figure></li><li><p>å›¾åƒä¿¡æ¯ä¿å­˜ï¼šsaveAvatarInfoä¸­é—´ä»¶</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> service = <span class="built_in">require</span>(<span class="string">&#x27;../service/file.service&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">fileController</span>&#123;</span><br><span class="line">  <span class="comment">// ä¸Šä¼ å›¾ç‰‡æ—¶ä¸ä»…è¦ä¼ å›¾ç‰‡ï¼Œè¿˜è¦å¯¹å›¾ç‰‡ä¿¡æ¯ç›¸å…³è¿›è¡Œä¿å­˜</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">saveAvatarInfo</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å›¾ç‰‡ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">const</span> &#123;filename, mimetype, size&#125; = ctx.<span class="property">req</span>.<span class="property">file</span></span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">user</span></span><br><span class="line">    <span class="comment">// å°†å›¾ç‰‡ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬åˆ›å»ºè¡¨</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">createAvatar</span>(filename, mimetype, size, id)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">fileController</span>()</span><br></pre></td></tr></table></figure><p>ctx.req.fileé‡Œé¢ä¿å­˜çš„ä¿¡æ¯ï¼š <img src="C:\Users\å°è™ç‰™\AppData\Roaming\Typora\typora-user-images\image-20210210154139788.png" alt="image-20210210154139788" style="zoom:50%"></p></li><li><p>serviceçš„æ“ä½œ</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> connection = <span class="built_in">require</span>(<span class="string">&quot;../app/database&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">fileService</span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">createAvatar</span>(<span class="params">filename, mimetype, size, user_id</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO avatar (filename, mimetype, size, user_id) VALUES (?, ?, ?, ?)`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [filename, mimetype, size, user_id])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">fileService</span>()</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210210162609117.png" alt="image-20210210162609117"></p></li></ul></li></ul><h4 id="2-è·å–å¤´åƒ">2. è·å–å¤´åƒ<a class="anchor" href="#2-è·å–å¤´åƒ">Â·</a></h4><ul><li>å®šä¹‰è·å–å›¾åƒçš„æ¥å£</li></ul><p>è¾“å…¥æµè§ˆå™¨çš„å¤´åƒï¼Œå¸Œæœ›ç›´æ¥å±•ç¤ºå‡ºæ¥ã€‚æ­¤æ—¶å¿…é¡»å•ç‹¬å†™ä¸ªæ¥å£ï¼Œç»™ç”¨æˆ·è¿”å›å¤´åƒ</p><p>è·å–ç”¨æˆ·ä¿¡æ¯çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥çœ‹åˆ°ç”¨æˆ·çš„å¤´åƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># user.router.js</span><br><span class="line">userRouter.get(&#x27;/:userId/avatar&#x27;, avatarInfo)</span><br></pre></td></tr></table></figure><ul><li>è¯·æ±‚ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œè·å–å¤´åƒ</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># user.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">avatarInfo</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// ç”¨æˆ·è·å–çš„æ–‡ä»¶id</span></span><br><span class="line">    <span class="keyword">const</span> &#123;userId&#125; = ctx.<span class="property">params</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> fileService.<span class="title function_">getAvatarByUserId</span>(userId) # file.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># file.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getAvatarByUserId</span>(<span class="params">userId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`SELECT * FROM avatar WHERE id = ?`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [userId])</span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è¿”å›çš„æ•°æ®ï¼š <img src="C:\Users\å°è™ç‰™\AppData\Roaming\Typora\typora-user-images\image-20210210171048347.png" alt="image-20210210171048347" style="zoom:50%"></p><p>è¦æƒ³å°†å›¾ç‰‡ä¿¡æ¯å±•ç¤ºå‡ºæ¥ï¼šctx.body = resultéœ€è¦ä¿®æ”¹ã€‚</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">avatarInfo</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">  <span class="comment">// ç”¨æˆ·è·å–çš„æ–‡ä»¶id</span></span><br><span class="line">  <span class="keyword">const</span> &#123;userId&#125; = ctx.<span class="property">params</span></span><br><span class="line">  <span class="keyword">const</span> avatarInfo = <span class="keyword">await</span> fileService.<span class="title function_">getAvatarByUserId</span>(userId)</span><br><span class="line">  ctx.<span class="property">body</span> = fs.<span class="title function_">createReadStream</span>(<span class="string">`<span class="subst">$&#123;AVATAR_PATH&#125;</span>/<span class="subst">$&#123;avatarInfo.filename&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"># <span class="variable constant_">AVATAR_PATH</span>æ˜¯å¯¼å…¥çš„è·¯å¾„å¸¸é‡ï¼š./upload/avatar  <span class="comment">// åœ¨constants/file-path.jsé‡Œ</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å›¾ç‰‡å†è¿›è¡Œè¯·æ±‚ï¼Œæµè§ˆå™¨è‡ªåŠ¨ä¸‹è½½æ–‡ä»¶ï¼Œå¹¶ä¸ä¼šå±•ç¤ºå›¾ç‰‡ï¼Œå› ä¸ºä»–ä¸çŸ¥é“æ˜¯å›¾ç‰‡è¿˜æ˜¯æ–‡ä»¶ã€‚è¿™ç§åšæ³•æ˜¯åªé€‚åˆæ™®é€šçš„å›¾ç‰‡ã€‚ç°åœ¨æˆ‘ä»¬è¦è®¾ç½®reponseï¼Œ æ‹¿åˆ°å“åº”å¯¹è±¡</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">ctx.<span class="property">response</span>.<span class="title function_">set</span>(<span class="string">&#x27;content-type&#x27;</span>, avatarInfo.<span class="property">mimetype</span>)</span><br><span class="line">ctx.<span class="property">body</span> = fs.<span class="title function_">createReadStream</span>(<span class="string">`<span class="subst">$&#123;AVATAR_PATH&#125;</span>/<span class="subst">$&#123;avatarInfo.filename&#125;</span>`</span>)</span><br></pre></td></tr></table></figure><ul><li><p>å¯¹userè¡¨æ·»åŠ ä¸€æ®µavatarï¼Œç”¨æ¥ä¿å­˜ç”¨æˆ·å¤´åƒçš„url</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">ALTER</span> <span class="variable constant_">TABLE</span> <span class="string">`users`</span> <span class="variable constant_">ADD</span> <span class="string">`avatar_url`</span> <span class="title function_">VARCHAR</span>(<span class="number">200</span>);</span><br></pre></td></tr></table></figure><p>å¸Œæœ›ç”¨æˆ·åœ¨ä¸Šä¼ å›¾åƒæˆåŠŸåï¼Œå°±ä¿å­˜è¿™ä¸ªurlã€‚åœ¨fileControllerä¸­ï¼Œä¸Šä¼ åå°†ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°usersè¡¨ä¸­ã€‚ä¿®æ”¹ä¹‹å‰ä¸Šä¼ å¤´åƒçš„æ¥å£ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># file.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">saveAvatarInfo</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å›¾ç‰‡ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">const</span> &#123;filename, mimetype, size&#125; = ctx.<span class="property">req</span>.<span class="property">file</span></span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">user</span></span><br><span class="line">    <span class="comment">// å°†å›¾ç‰‡ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬åˆ›å»ºè¡¨</span></span><br><span class="line">   <span class="keyword">const</span> res =  <span class="keyword">await</span> service.<span class="title function_">createAvatar</span>(filename, mimetype, size, id)</span><br><span class="line">  <span class="comment">// ä¿å­˜å›¾ç‰‡åœ°å€åœ¨usersè¡¨é‡Œ</span></span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å›¾ç‰‡è·¯å¾„</span></span><br><span class="line">    <span class="keyword">const</span> avatarUrl = <span class="string">`<span class="subst">$&#123;AVATAR_PATH&#125;</span>/<span class="subst">$&#123;filename&#125;</span>`</span></span><br><span class="line">    <span class="comment">//æ›´æ”¹usersè¡¨</span></span><br><span class="line">    <span class="keyword">await</span> userService.<span class="title function_">updateAvatarUrlById</span>(avatarUrl, id)</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;ç”¨æˆ·å¤´åƒä¸Šä¼ å¤´åƒ&#x27;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># file.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">createAvatar</span>(<span class="params">filename, mimetype, size, user_id</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO avatar </span></span><br><span class="line"><span class="string">    								(filename, mimetype, size, user_id) VALUES (?, ?, ?, ?)`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, </span><br><span class="line">    									[filename, mimetype, size, user_id])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># user.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">updateAvatarUrlById</span>(<span class="params">avatarUrl, id</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`UPDATE users SET avatar_url = ? WHERE id = ?`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [avatarUrl, id])</span><br><span class="line">    <span class="keyword">return</span> result[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ä¸Šä¼ å¤´åƒï¼Œusersé‡Œå°±æœ‰urlå­—æ®µå­˜å‚¨ç€åœ°å€ <img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210210195615751.png" alt="image-20210210195615751"></p><p>ä½†è¿™ä¸ªåœ°å€æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ›´æ”¹ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># æ›´æ”¹env</span><br><span class="line"><span class="variable constant_">APP_PORT</span> = <span class="number">8000</span></span><br><span class="line"><span class="variable constant_">LOCAL_HOST</span> = <span class="string">&quot;localhost</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># config.<span class="property">js</span></span><br><span class="line">å¯¼å‡ºå¢åŠ è¿™ä¸€é¡¹</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> avatarUrl = <span class="string">`<span class="subst">$&#123;AVATAR_PATH&#125;</span>/<span class="subst">$&#123;filename&#125;</span>`</span></span><br><span class="line">æ›´æ”¹ä¸ºï¼š</span><br><span class="line"><span class="keyword">const</span> avatarUrl = <span class="string">`<span class="subst">$&#123;LOCAL_HOST&#125;</span>:<span class="subst">$&#123;APP_PORT&#125;</span>/<span class="subst">$&#123;id&#125;</span>/avatar`</span></span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210210201631018.png" alt="image-20210210201631018"></p></li></ul><h4 id="3-ä¸Šä¼ åŠ¨æ€çš„é…å›¾">3. ä¸Šä¼ åŠ¨æ€çš„é…å›¾<a class="anchor" href="#3-ä¸Šä¼ åŠ¨æ€çš„é…å›¾">Â·</a></h4><ul><li><p>å®šä¹‰ä¸Šä¼ åŠ¨æ€é…å›¾çš„æ¥å£</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># file.<span class="property">router</span>.<span class="property">js</span></span><br><span class="line">fileRouter.<span class="title function_">post</span>(<span class="string">&#x27;/picture&#x27;</span>, verifyAuth, pictureHandle)</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># fie.<span class="property">middleware</span>.<span class="property">js</span></span><br><span class="line"><span class="comment">// ä¸Šä¼ åŠ¨æ€å›¾</span></span><br><span class="line"><span class="keyword">const</span> uploadPicture = <span class="title class_">Multer</span>(&#123;</span><br><span class="line">  <span class="attr">dest</span>: <span class="variable constant_">PICTURE_PATH</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> pictureHandle = uploadPicture.<span class="title function_">array</span>(<span class="string">&#x27;picture&#x27;</span>, <span class="number">9</span>)</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºè¡¨fileå­˜å‚¨ä¸Šä¼ çš„åŠ¨æ€é…å›¾</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">TABLE</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">`file`</span>(</span><br><span class="line">	id <span class="variable constant_">INT</span> <span class="variable constant_">PRIMARY</span> <span class="variable constant_">KEY</span> <span class="variable constant_">AUTO_INCREMENT</span>,</span><br><span class="line">	filename <span class="title function_">VARCHAR</span>(<span class="number">100</span>) <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span> <span class="variable constant_">UNIQUE</span>,</span><br><span class="line">	mimetype <span class="title function_">VARCHAR</span>(<span class="number">30</span>),</span><br><span class="line">	size <span class="variable constant_">INT</span>,</span><br><span class="line">	moment_id <span class="variable constant_">INT</span>,</span><br><span class="line">	user_id <span class="variable constant_">INT</span>,</span><br><span class="line">	createAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">	updateAt <span class="variable constant_">TIMESTAMP</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CURRENT_TIMESTAMP</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CURRENT_TIMESTAMP</span>,</span><br><span class="line">	<span class="variable constant_">FOREIGN</span> <span class="variable constant_">KEY</span> (user_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">users</span>(id) <span class="variable constant_">ON</span> <span class="variable constant_">DELETE</span> <span class="variable constant_">CASCADE</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CASCADE</span>,</span><br><span class="line">	<span class="variable constant_">FOREIGN</span> <span class="variable constant_">KEY</span> (moment_id) <span class="variable constant_">REFERENCES</span> <span class="title function_">moment</span>(id) <span class="variable constant_">ON</span> <span class="variable constant_">DELETE</span> <span class="variable constant_">CASCADE</span> <span class="variable constant_">ON</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">CASCADE</span></span><br><span class="line">	);</span><br></pre></td></tr></table></figure></li><li><p>æˆ‘å¸Œæœ›ä¸Šä¼ æ—¶ï¼ŒæŠŠqueryå‚æ•°ä¸€èµ·ä¼ è¿‡æ¥ï¼š</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># # file.<span class="property">router</span>.<span class="property">js</span></span><br><span class="line">fileRouter.<span class="title function_">post</span>(<span class="string">&#x27;/picture&#x27;</span>, verifyAuth, pictureHandle, savePictureInfo)</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># file.<span class="property">controller</span>.<span class="property">js</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">savePictureInfo</span>(<span class="params">ctx, next</span>)&#123;</span><br><span class="line">    <span class="comment">// è·å–å¤´åƒä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">const</span> files = ctx.<span class="property">req</span>.<span class="property">files</span></span><br><span class="line">    <span class="keyword">const</span> &#123;id&#125; = ctx.<span class="property">user</span></span><br><span class="line">    <span class="keyword">const</span> &#123;momentId&#125; = ctx.<span class="property">query</span></span><br><span class="line">    <span class="comment">// å°†æ‰€æœ‰çš„æ–‡ä»¶ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> file <span class="keyword">of</span> files)&#123;</span><br><span class="line">      <span class="comment">// æ‹¿åˆ°å›¾ç‰‡ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">const</span> &#123;originalname, mimetype, size&#125; = file</span><br><span class="line">    <span class="comment">// æ‹¿user_id</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> service.<span class="title function_">createPicture</span>(</span><br><span class="line">      						 originalname, mimetype, size, momentId, id)</span><br><span class="line">    ctx.<span class="property">body</span> = result</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"># file.<span class="property">service</span>.<span class="property">js</span></span><br><span class="line"> <span class="keyword">async</span> <span class="title function_">createPicture</span>(<span class="params">originalname, mimetype, size, momentId, userId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> statement = <span class="string">`INSERT INTO file (filename, mimetype, size, moment_id, user_id) </span></span><br><span class="line"><span class="string">                       VALUES (?, ?, ?, ?, ?);`</span></span><br><span class="line">    <span class="keyword">const</span> [result] = <span class="keyword">await</span> connection.<span class="title function_">execute</span>(statement, [originalname, mimetype, size, momentId, userId,])</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="C:%5CUsers%5C%E5%B0%8F%E8%99%8E%E7%89%99%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210210213006041.png" alt="image-20210210213006041"></p><p>ä»æœåŠ¡å™¨æ‹¿åˆ°çš„å›¾ç‰‡æ˜¯åŸå›¾ï¼ŒæœåŠ¡å™¨ä¼šå¯¹ä¸Šä¼ çš„å›¾ç‰‡è¿›è¡Œä¸€äº›å¤„ç†ï¼Œä¸¾ä¾‹ä¸€å¼ å›¾åƒå˜æˆ3å¼ ï¼ˆ1280ã€640ã€320ï¼‰ã€‚å½“æˆ‘ä»¬åœ¨åˆ—è¡¨ä¸­å±•ç¤ºå›¾ç‰‡çš„æ—¶å€™ï¼Œå¯ä»¥æä¾›ä¸åŒç±»å‹çš„å›¾ç‰‡ï¼Œè¿™æ˜¯å°±éœ€è¦å¯¹ç”¨æˆ·ä¸Šä¼ è¿‡æ¥çš„å›¾ç‰‡è¿›è¡Œä¸“é—¨çš„å¤„ç†ã€‚</p></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>é¡¹ç›®5ï¼šNodeç”¨æˆ·ç®¡ç†æ¥å£ï¼šå­¦ä¹ è®°å½•ç¯‡</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.nesxc.com/post/hexocc.html">https://www.nesxc.com/post/hexocc.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>é£å„¿</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2021-12-12</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2023-01-09</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post_share"><div class="social-share" data-image="https://images.unsplash.com/photo-1638645671264-82cae622dada?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHx0b3BpYy1mZWVkfDUwfHhIeFlUTUhMZ09jfHxlbnwwfHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=500&amp;q=60" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div id="wpac-rating"></div><script>wpac_init = window.wpac_init || [];
wpac_init.push({widget: 'Rating', id: 33234});
(function() {
  if ('WIDGETPACK_LOADED' in window) return;
  WIDGETPACK_LOADED = true;
  var mc = document.createElement('script');
  mc.type = 'text/javascript';
  mc.async = true;
  //- mc.src = '//embed.widgetpack.com/widget.js';
  var s = document.getElementsByTagName('script')[0];
  s?.parentNode?.insertBefore(mc, s?.nextSibling);
})();</script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/1720673220.html"><img class="prev-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror='onerror=null,src="https://mynightwish.oss-cn-beijing.aliyuncs.com/staticResource/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ç»å…¸å›½å†…å¤–è®¡ç®—æœºåŸºç¡€è¯¾ç¨‹</div></div></a></div><div class="next-post pull-right"><a href="/posts/3253305718.html"><img class="next-cover" src="https://images.unsplash.com/photo-1638645671264-82cae622dada?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHx0b3BpYy1mZWVkfDUwfHhIeFlUTUhMZ09jfHxlbnwwfHx8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=500&amp;q=60" onerror='onerror=null,src="https://mynightwish.oss-cn-beijing.aliyuncs.com/staticResource/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">é¡¹ç›®5ï¼šNodeç”¨æˆ·ç®¡ç†æ¥å£ï¼šé¡¹ç›®æ¢³ç†ç¯‡</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="toc-text">é¡¹ç›®å®æˆ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%92%E5%88%86%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-text">1. åˆ’åˆ†ç›®å½•ç»“æ„</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF%EF%BC%9A"><span class="toc-text">é¡¹ç›®é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6%EF%BC%9Amain-js"><span class="toc-text">é¡¹ç›®çš„å…¥å£æ–‡ä»¶ï¼šmain.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%9Aindex-js"><span class="toc-text">åˆ›å»ºæœåŠ¡å™¨ï¼šindex.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8F%98%E9%87%8F%EF%BC%9Aconfig-js"><span class="toc-text">åŠ è½½é…ç½®çš„å˜é‡ï¼šconfig.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99-env%E6%96%87%E4%BB%B6"><span class="toc-text">ç¼–å†™.envæ–‡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B%E6%A8%A1%E5%9D%97%EF%BC%9Aerror-type-js"><span class="toc-text">é”™è¯¯ç±»å‹æ¨¡å—ï¼šerror-type.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%A8%A1%E5%9D%97-%EF%BC%9Aerror-handle-js"><span class="toc-text">é”™è¯¯å¤„ç†æ¨¡å— ï¼šerror-handle.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%EF%BC%9Adatabase-js"><span class="toc-text">æ•°æ®åº“è¿æ¥ï¼šdatabase.js</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3"><span class="toc-text">2. ç”¨æˆ·æ³¨å†Œæ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7%E6%A0%A1%E9%AA%8C%EF%BC%9AverifyUser"><span class="toc-text">æ³¨å†Œç”¨æˆ·æ ¡éªŒï¼šverifyUser</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C%EF%BC%9Acreate-js"><span class="toc-text">æ³¨å†Œç”¨æˆ·æ“ä½œï¼šcreate.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E5%AD%98%E5%82%A8"><span class="toc-text">å¯†ç åŠ å¯†å­˜å‚¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3"><span class="toc-text">3. ç™»å½•æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E5%A4%84%E7%90%86%EF%BC%9Alogin"><span class="toc-text">ç™»å½•å¤„ç†ï¼šlogin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E9%AA%8C%E8%AF%81%EF%BC%9A"><span class="toc-text">å¯†ç éªŒè¯ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C%EF%BC%8C%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E8%B7%AF%E7%94%B1%EF%BC%9A"><span class="toc-text">ä¼˜åŒ–è·¯ç”±æ³¨å†Œï¼ŒåŠ¨æ€åŠ è½½è·¯ç”±ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%99%BB%E5%BD%95%E5%87%AD%E8%AF%81%EF%BC%9A"><span class="toc-text">4. ç™»å½•å‡­è¯ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86"><span class="toc-text">éå¯¹ç§°åŠ å¯†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%81%E5%8F%91%E4%BB%A4%E7%89%8C-%E9%AA%8C%E8%AF%81%E4%BB%A4%E7%89%8C%EF%BC%88%E5%9B%9E%E5%88%B0%E9%A1%B9%E7%9B%AE%EF%BC%89"><span class="toc-text">é¢å‘ä»¤ç‰Œ+éªŒè¯ä»¤ç‰Œï¼ˆå›åˆ°é¡¹ç›®ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E6%8E%88%E6%9D%83%EF%BC%8C%E9%A2%81%E5%8F%91%E7%9A%84%E7%AD%BE%E5%90%8D%E6%98%AF%E5%90%A6%E6%9C%89%E6%95%88"><span class="toc-text">éªŒè¯ç”¨æˆ·æ˜¯å¦æˆæƒï¼Œé¢å‘çš„ç­¾åæ˜¯å¦æœ‰æ•ˆ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%8F%91%E5%B8%83-%E6%9F%A5%E8%AF%A2%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9"><span class="toc-text">5.1 å‘å¸ƒ&#x2F;æŸ¥è¯¢åŠ¨æ€å†…å®¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8F%91%E5%B8%83%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9"><span class="toc-text">1. å‘å¸ƒåŠ¨æ€å†…å®¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9F%A5%E8%AF%A2%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9"><span class="toc-text">2.æŸ¥è¯¢åŠ¨æ€å†…å®¹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E4%BF%AE%E6%94%B9-%E5%88%A0%E9%99%A4%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9"><span class="toc-text">5.2 ä¿®æ”¹&#x2F;åˆ é™¤åŠ¨æ€å†…å®¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%9A%E4%B9%89%E4%BF%AE%E6%94%B9%E5%8A%A8%E6%80%81%E5%86%85%E5%AE%B9%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">1. å®šä¹‰ä¿®æ”¹åŠ¨æ€å†…å®¹çš„æ¥å£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E7%8B%AC%E5%B0%81%E8%A3%85%E6%9D%83%E9%99%90%E6%9F%A5%E8%AF%A2%E7%9A%84%E5%87%BD%E6%95%B0%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%BA%E4%BA%86%E5%90%8E%E7%BB%AD%E5%90%84%E7%A7%8D%E9%9C%80%E8%A6%81%E6%9D%83%E9%99%90%E7%9A%84%E6%93%8D%E4%BD%9C%E6%97%B6%EF%BC%8C%E4%B8%8D%E7%94%A8%E5%86%8D%E9%87%8D%E5%A4%8D%E5%86%99"><span class="toc-text">å•ç‹¬å°è£…æƒé™æŸ¥è¯¢çš„å‡½æ•°ï¼Œè¿™æ˜¯ä¸ºäº†åç»­å„ç§éœ€è¦æƒé™çš„æ“ä½œæ—¶ï¼Œä¸ç”¨å†é‡å¤å†™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%9A%E4%B9%89%E5%88%A0%E9%99%A4%E5%86%85%E5%AE%B9%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">2. å®šä¹‰åˆ é™¤å†…å®¹çš„æ¥å£</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%8F%91%E8%A1%A8-%E4%BF%AE%E6%94%B9%E8%AF%84%E8%AE%BA%E5%86%85%E5%AE%B9"><span class="toc-text">6.1 å‘è¡¨&#x2F;ä¿®æ”¹è¯„è®ºå†…å®¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%9A%E4%B9%89%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA%E5%86%85%E5%AE%B9%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">1. å®šä¹‰å‘å¸ƒè¯„è®ºå†…å®¹çš„æ¥å£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%9A%E4%B9%89%E5%9B%9E%E5%A4%8D%E8%AF%84%E8%AE%BA%E5%86%85%E5%AE%B9%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">2. å®šä¹‰å›å¤è¯„è®ºå†…å®¹çš„æ¥å£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%9A%E4%B9%89%E4%BF%AE%E6%94%B9%E8%AF%84%E8%AE%BA%E5%86%85%E5%AE%B9%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">3. å®šä¹‰ä¿®æ”¹è¯„è®ºå†…å®¹çš„æ¥å£</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%88%A0%E9%99%A4-%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E5%86%85%E5%AE%B9"><span class="toc-text">6.2 åˆ é™¤&#x2F;æŸ¥è¯¢è¯„è®ºå†…å®¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%9A%E4%B9%89%E5%88%A0%E9%99%A4%E8%AF%84%E8%AE%BA%E5%86%85%E5%AE%B9%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-text">1. å®šä¹‰åˆ é™¤è¯„è®ºå†…å®¹çš„æ¥å£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9F%A5%E8%AF%A2%E5%8A%A8%E6%80%81"><span class="toc-text">2. æŸ¥è¯¢åŠ¨æ€</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E6%A0%87%E7%AD%BE%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%88%E5%A4%9A%E5%AF%B9%E5%A4%9A%EF%BC%89"><span class="toc-text">7. æ ‡ç­¾æ¥å£å¼€å‘ï¼ˆå¤šå¯¹å¤šï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E6%A0%87%E7%AD%BE%E6%8E%A5%E5%8F%A3"><span class="toc-text">1. åˆ›å»ºæ ‡ç­¾æ¥å£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%BB%99%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E6%A0%87%E7%AD%BE"><span class="toc-text">2. ç»™åŠ¨æ€æ·»åŠ æ ‡ç­¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B1%95%E7%A4%BA%E6%A0%87%E7%AD%BE"><span class="toc-text">3. å±•ç¤ºæ ‡ç­¾</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="toc-text">8. ä¸Šä¼ å›¾ç‰‡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF%EF%BC%9A"><span class="toc-text">åˆ†æå®ç°æ€è·¯ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%B8%8A%E4%BC%A0%E5%A4%B4%E5%83%8F"><span class="toc-text">1. ä¸Šä¼ å¤´åƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%8E%B7%E5%8F%96%E5%A4%B4%E5%83%8F"><span class="toc-text">2. è·å–å¤´åƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%B8%8A%E4%BC%A0%E5%8A%A8%E6%80%81%E7%9A%84%E9%85%8D%E5%9B%BE"><span class="toc-text">3. ä¸Šä¼ åŠ¨æ€çš„é…å›¾</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By é£å„¿</div><div id="running-time"></div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="åšå®¢æ¡†æ¶ä¸º Hexo" alt="HEXO"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="ä¸»é¢˜é‡‡ç”¨ Butterfly" alt="Butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://www.jsdelivr.com/"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="æœ¬ç«™ä½¿ç”¨ Jsdelivr ä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ" alt="Jsdelivr"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="æœ¬ç«™é¡¹ç›®ç”± GitHub æ‰˜ç®¡" alt="GitHub"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="to_comment" type="button" title="ç›´è¾¾è¯„è®º" onclick="FixedCommentBtn()"><i class="fas fa-comments"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight,500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=document.getElementById("twikoo-count"),o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo-hexo-vert.vercel.app/",region:""},null))},e=()=>{twikoo.getCommentsCount({envId:"https://twikoo-hexo-vert.vercel.app/",region:"",urls:[window.location.pathname],includeReply:!1}).then((function(o){t.innerText=o[0].count})).catch((function(t){console.error(t)}))},n=(n=!1)=>{"object"==typeof twikoo?(o(),n&&t&&setTimeout(e,0)):getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js").then(()=>{o(),n&&t&&setTimeout(e,0)})};btf.loadComment(document.getElementById("twikoo-wrap"),n)})()</script></div><script defer data-pjax src="/js/nav.js"></script><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script defer src="/js/cursor.js"></script><script async src="//at.alicdn.com/t/c/font_3859043_rw1ayonelb.js"></script><script defer data-pjax src="/js/meihua.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script defer data-pjax src="/js/bottomTime.js"></script><script defer data-pjax src="/js/sun_moon.js" async></script><script defer data-pjax src="/js/emoji.js"></script><div id="live3d" class="live3d" style="position:fixed;left:-110px;bottom:30px;z-index:98"><canvas id="live2dm" class="live3d" style="max-width:500px;max-height:437.5px"></canvas></div><script defer data-pjax src="https://cdn.jsdelivr.net/npm/hexo-beautiful-page@latest/lib/asyncmodel.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.removeEventListener("scroll",window.tocScrollFn),window.removeEventListener("scroll",scrollCollect),"object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script data-pjax>if(document.getElementById("recent-posts")&&"/"===location.pathname){var parent=document.getElementById("recent-posts"),child='<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/1-1-CSS/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŒ° CSS<br>(17)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/1-2-JS/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥‘ JSã€ES<br>(29)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/1-3-Ajax/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ Ajaxã€Axios<br>(3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/1-4-æ¡†æ¶/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¡ Reactã€Vue<br>(15)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/2-1-ç»„ä»¶åº“/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ ç»„ä»¶åº“å¼€å‘<br>(2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/2-2-åŸºå»º/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¹ é¡¹ç›®åŸºå»º<br>(5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/2-3-å®ç°Tricks/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ’« ç§¯ç´¯åŠŸèƒ½<br>(4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/2-4-é¡¹ç›®/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ”® é¡¹ç›®æ€»ç»“<br>(12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/3-1-è®°å½•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‘» ç¢ç¢å¿µ~<br>(3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/3-2-æµè§ˆå™¨/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ’¡ æµè§ˆå™¨æ¸²æŸ“<br>(8)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/3-3-åŸºç¡€/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ§Š ç½‘ç»œ<br>(10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://mynightwish.online/categories/3-4-Tool/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¤ å·¥å…·ã€è„šæœ¬<br>(1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://mynightwish.online/categories" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';console.log("å·²æŒ‚è½½magnet"),parent.insertAdjacentHTML("afterbegin",child)}</script><style>#catalog_magnet{flex-wrap:wrap;display:flex;width:100%;justify-content:space-between;padding:10px 10px 0 10px;align-content:flex-start}.magnet_item{flex-basis:calc(25% - 5px);background:#f2f2f2;margin-bottom:10px;border-radius:8px;transition:all .2s ease-in-out}.magnet_item:hover{background:#b30070}.magnet_link_more{color:#555}.magnet_link{color:#000}.magnet_link:hover{color:#fff}@media screen and (max-width:600px){.magnet_item{flex-basis:100%}}.magnet_link_context{display:flex;padding:10px;font-size:16px;transition:all .2s ease-in-out}.magnet_link_context:hover{padding:10px 20px}</style><style></style><script data-pjax>function butterfly_swiper_injector_config(){var s=document.getElementById("recent-posts");console.log("å·²æŒ‚è½½butterfly_swiper"),s.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2621268747.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://mynightwish.oss-cn-beijing.aliyuncs.com/React/react-virtualDom.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-12-13</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2621268747.html&quot;);" href="javascript:void(0);" alt="">Reactçš„è™šæ‹ŸDOM</a><div class="blog-slider__text">å…„å¼Ÿç¯‡Reactçš„è™šæ‹ŸDOMï¼ŒåŒ…æ‹¬äº†æ ˆè°ƒå’Œ</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2621268747.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/ReactHooks.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://mynightwish.oss-cn-beijing.aliyuncs.com/React/hook1.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/ReactHooks.html&quot;);" href="javascript:void(0);" alt="">React-Hookçš„å‡ºç°</a><div class="blog-slider__text">ä¸ºä½•Hooksæ˜¯Reactçš„æœªæ¥</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/ReactHooks.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/656350506.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://mynightwish.oss-cn-beijing.aliyuncs.com/CSS/æµè§ˆå™¨å¼‚æ­¥.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/656350506.html&quot;);" href="javascript:void(0);" alt="">JSçš„EventLoop</a><div class="blog-slider__text">å¼‚æ­¥ä¸åŒæ­¥ã€å®ä»»åŠ¡ã€å¾®ä»»åŠ¡</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/656350506.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/3384747987.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTfnIl0f3oUJLgGFb7Qgi97y1hY9uIQsHizXQ&amp;usqp=CAU" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-12-11</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/3384747987.html&quot;);" href="javascript:void(0);" alt="">JSçš„å¼‚æ­¥è§£å†³æ–¹æ¡ˆ</a><div class="blog-slider__text">å‰ç«¯å¼‚æ­¥ä¹‹è·¯</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/3384747987.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>')}for(var elist="undefined".split(","),cpage=location.pathname,epage="/",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_swiper_injector_config()</script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script async>window.onload=function(){var e=document.createElement("script"),t=document.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.src="/sw-register.js?v="+Date.now(),t.parentNode.insertBefore(e,t)}</script></body></html>